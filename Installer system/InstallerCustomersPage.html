<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×œ×§×•×—×•×ª</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/ajaxCall.js"></script>
  <script src="/api.js"></script>
  <style>
    :root {
      --main-color: #b46a2c;
      --text-dark: #333;
      --light-gray: #f5f5f5;
      --radius: 12px;
    }
    body {
      margin: 0;
      font-family: "Heebo", sans-serif;
      background-color: #fafafa;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 200px;
      background-color: #fff;
      padding: 20px;
      border-left: 1px solid #ddd;
    }
    .sidebar .logo {
      text-align: center;
      margin-bottom: 40px;
    }
    .sidebar nav a {
      display: block;
      padding: 12px;
      color: var(--text-dark);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .sidebar nav a.active {
      background-color: #e6f2f2;
      font-weight: bold;
    }
    .main {
      flex: 1;
      padding: 30px;
    }
    .top-bar {
      margin-bottom: 20px;
    }
    
    .filters,
    .sorters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    .filters label,
    .sorters label {
      font-weight: bold;
      margin-left: 10px;
    }
    .filters input,
    .filters select,
    .sorters select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
    }
    .btn {
      background-color: var(--main-color);
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
    }
    .arrow-btn {
      background: none;
      border: none;
      color: var(--main-color);
      font-size: 18px;
      cursor: pointer;
    }
    .customers-table {
      background: #fff;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th,
    td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      text-align: right;
      font-size: 14px;
    }
    th {
      background-color: #f9f9f9;
      font-weight: bold;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .status {
      color: var(--main-color);
      font-weight: bold;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .actions span {
      cursor: pointer;
      font-size: 16px;
    }
    a.customer-link {
      color: var(--main-color);
      text-decoration: none;
      font-weight: bold;
    }
    .no-results {
      color: var(--main-color);
      font-weight: bold;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo">
        <img src="../picturs/logo.png" alt="×œ×•×’×•" width="100" />
      </div>
      <nav>
        <a href="#">××¡×š ×”×‘×™×ª</a>
        <a href="#">×œ×¢×•××§</a>
        <a href="#">×¡×˜×˜×•×¡×™× ×œ×‘×™×¦×•×¢</a>
        <a href="#">× ×™×”×•×œ ×”×ª×§× ×•×ª</a>
        <a href="#" class="active">×œ×§×•×—×•×ª</a>
        <a href="#">×™×•××Ÿ</a>
        <a href="#">×”×’×“×¨×•×ª</a>
        <a href="#">×”×ª× ×ª×§×•×ª</a>
      </nav>
    </aside>
    <main class="main">
      <div class="top-bar">
        <h2>×œ×§×•×—×•×ª</h2>
      </div>

      <div class="filters">
        <label><strong>×¡× ×Ÿ ×œ×¤×™:</strong></label>
        <input type="text" id="filterName" placeholder="×©× ×œ×§×•×—" />
        <input type="text" id="filterCity" placeholder="×¢×™×¨" />
        <select id="filterStatus">
          <option value="">×¡×˜×˜×•×¡</option>
          <option value="×˜×™×•×˜×”">×˜×™×•×˜×”</option>
          <option value="×¦×¤×™×™×” ×‘×¡×¨×˜×•×Ÿ ×œ×§×•×—">×¦×¤×™×™×” ×‘×¡×¨×˜×•×Ÿ ×œ×§×•×—</option>
          <option value="×˜×™×•×˜×” ×œ×”×¦×¢×ª ××—×™×¨">×˜×™×•×˜×” ×œ×”×¦×¢×ª ××—×™×¨</option>
          <option value="×©×œ×™×—×ª ×˜×™×•×˜×” ×œ×œ×§×•×—">×©×œ×™×—×ª ×˜×™×•×˜×” ×œ×œ×§×•×—</option>
          <option value="×”×¢×‘×¨×” ××§×“××”">×”×¢×‘×¨×” ××§×“××”</option>
          <option value="×ª×™××•× ×”×ª×§× ×”">×ª×™××•× ×”×ª×§× ×”</option>
          <option value="×”×ª×§× ×” ×‘×•×¦×¢×”">×”×ª×§× ×” ×‘×•×¦×¢×”</option>
          <option value="×§×‘×œ×ª ××©×•×‘">×§×‘×œ×ª ××©×•×‘</option>
        </select>

        <label for="filterDateType"><strong></strong></label>
        <select id="filterDateType">
          <option value="PlannedDate">×ª××¨×™×š ×”×ª×§× ×”</option>
          <option value="CustomerCreatedAt">×ª××¨×™×š ×™×¦×™×¨×”</option>
        </select>

        <input type="date" id="filterFromDate" />
        <input type="date" id="filterToDate" />
        <button class="btn" onclick="loadCustomers()">×¡× ×Ÿ</button>
        <button class="btn" onclick="resetFilters()">×‘×˜×œ ×¡×™× ×•×Ÿ</button>
      </div>

      <div class="sorters">
        <label><strong>××™×™×Ÿ ×œ×¤×™:</strong></label>
        <div>
          <select id="primarySort">
            <option value="">××™×•×Ÿ ×¨××©×™</option>
            <option value="Name">×©× ×œ×§×•×—</option>
            <option value="City">×¢×™×¨</option>
            <option value="Status">×¡×˜×˜×•×¡</option>
            <option value="CustomerCreatedAt">×ª××¨×™×š ×™×¦×™×¨×”</option>
            <option value="PlannedDate">×ª××¨×™×š ×”×ª×§× ×”</option>
          </select>
          <span class="arrow-btn" onclick="setSortDirection('primary', 'asc')">&#x25B2;</span>
          <span class="arrow-btn" onclick="setSortDirection('primary', 'desc')">&#x25BC;</span>
        </div>
        <div>
          <select id="secondarySort">
            <option value="">××™×•×Ÿ ××©× ×™</option>
            <option value="Name">×©× ×œ×§×•×—</option>
            <option value="City">×¢×™×¨</option>
            <option value="Status">×¡×˜×˜×•×¡</option>
            <option value="CustomerCreatedAt">×ª××¨×™×š ×™×¦×™×¨×”</option>
            <option value="PlannedDate">×ª××¨×™×š ×”×ª×§× ×”</option>
          </select>
          <span class="arrow-btn" onclick="setSortDirection('secondary', 'asc')">&#x25B2;</span>
          <span class="arrow-btn" onclick="setSortDirection('secondary', 'desc')">&#x25BC;</span>
        </div>
        <button class="btn" onclick="loadCustomers()">××™×™×Ÿ</button>
        <button class="btn" onclick="resetSorting()">×‘×˜×œ ××™×•×Ÿ</button>
      </div>

      <div class="customers-table">
        <h4 style="margin-bottom: 10px">×¨×©×™××ª ×œ×§×•×—×•×ª</h4>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>×©× ×œ×§×•×—</th>
              <th>×˜×œ×¤×•×Ÿ</th>
              <th>×¢×™×¨</th>
              <th>×¡×˜×˜×•×¡</th>
              <th>×ª××¨×™×š ×™×¦×™×¨×”</th>
              <th>×ª××¨×™×š ×”×ª×§× ×”</th>
              <th>×¤×¢×•×œ×•×ª</th>
            </tr>
          </thead>
          <tbody id="customersBody">
            <tr>
              <td colspan="8">×˜×•×¢×Ÿ × ×ª×•× ×™×...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    let sortDirections = { primary: 'asc', secondary: 'asc' };
  
    function setSortDirection(level, direction) {
      sortDirections[level] = direction;
      loadCustomers();
    }
  
    function resetFilters() {
      document.getElementById("filterName").value = "";
      document.getElementById("filterCity").value = "";
      document.getElementById("filterStatus").value = "";
      document.getElementById("filterFromDate").value = "";
      document.getElementById("filterToDate").value = "";
      document.getElementById("filterDateType").value = "PlannedDate";
      loadCustomers();
    }
  
    function resetSorting() {
      document.getElementById("primarySort").value = "";
      document.getElementById("secondarySort").value = "";
      sortDirections.primary = 'asc';
      sortDirections.secondary = 'asc';
      loadCustomers();
    }
  
    document.addEventListener("DOMContentLoaded", loadCustomers);
  
    function loadCustomers() {
      const fromDateValue = document.getElementById("filterFromDate").value;
      const toDateValue = document.getElementById("filterToDate").value;
      const dateField = document.getElementById("filterDateType").value || "PlannedDate";
  
      const nameFilter = document.getElementById("filterName").value?.toLowerCase() || "";
      const cityFilter = document.getElementById("filterCity").value?.toLowerCase() || "";
      const statusFilter = document.getElementById("filterStatus").value || "";
  
      const primarySort = document.getElementById("primarySort").value;
      const secondarySort = document.getElementById("secondarySort").value;
  
      ajaxCall(
        "POST",
        `${API_BASE_URL}/Dashboard/GetDashboardData`,
        JSON.stringify({}),
        function (data) {
          if (!Array.isArray(data)) return;
  
          let filtered = data.filter(c => {
            const fullName = `${c.FirstName || ''} ${c.LastName || ''}`.toLowerCase();
            const city = (c.City || "").toLowerCase();
            const status = c.Status || "";
  
            const nameMatch = fullName.includes(nameFilter);
            const cityMatch = city.includes(cityFilter);
            const statusMatch = statusFilter === "" || status === statusFilter;
  
            // ğŸ‘‡ ×ª×™×§×•×Ÿ: ×¡×™× ×•×Ÿ ×œ×¤×™ ×˜×•×•×— ×ª××¨×™×›×™× ×›×•×œ×œ ×ª××¨×™×š ×§×¦×”
            let dateMatch = true;
            if (fromDateValue || toDateValue) {
              const compareDate = new Date(c[dateField]);
              compareDate.setHours(0, 0, 0, 0); // ×œ××™×¤×•×¡
  
              const fromDate = fromDateValue ? new Date(fromDateValue) : null;
              if (fromDate) fromDate.setHours(0, 0, 0, 0);
  
              const toDate = toDateValue ? new Date(toDateValue) : null;
              if (toDate) toDate.setHours(23, 59, 59, 999); // ×¡×•×£ ×”×™×•×
  
              if (fromDate && compareDate < fromDate) dateMatch = false;
              if (toDate && compareDate > toDate) dateMatch = false;
            }
  
            return nameMatch && cityMatch && statusMatch && dateMatch;
          });
  
          filtered.sort((a, b) => {
            const result1 = compareValues(a, b, primarySort, sortDirections.primary);
            if (result1 !== 0) return result1;
            return compareValues(a, b, secondarySort, sortDirections.secondary);
          });
  
          const tbody = document.getElementById("customersBody");
          tbody.innerHTML = "";
  
          if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="no-results">×œ× × ××¦××• ×œ×§×•×—×•×ª</td></tr>`;
            return;
          }
  
          filtered.forEach((c, index) => {
            const fullName = `${c.FirstName} ${c.LastName}`.trim();
            const createdAt = new Date(c.CustomerCreatedAt).toLocaleDateString("he-IL");
            const plannedDate = c.PlannedDate ? new Date(c.PlannedDate).toLocaleDateString("he-IL") : "";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${index + 1}</td>
              <td><a href="InstallerCustomerDetailsPage.html?id=${c.CustomerID}" class="customer-link">${fullName}</a></td>
              <td>${c.Phone || ""}</td>
              <td>${c.City || ""}</td>
              <td class="status">${c.Status || ""}</td>
              <td>${createdAt}</td>
              <td>${plannedDate}</td>
              <td class="actions">
                <span title="×¢×¨×•×š" onclick="editCustomer(${c.CustomerID})">âœï¸</span>
                <span title="××—×§" onclick="deleteCustomer(${c.CustomerID})">ğŸ—‘ï¸</span>
              </td>
            `;
            tbody.appendChild(tr);
          });
        },
        function (err) {
          console.error(err);
          document.getElementById("customersBody").innerHTML =
            '<tr><td colspan="8">×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª</td></tr>';
        }
      );
    }
  
    function compareValues(a, b, key, direction = 'asc') {
      const valA = getSortValue(a, key);
      const valB = getSortValue(b, key);
      if (valA < valB) return direction === 'asc' ? -1 : 1;
      if (valA > valB) return direction === 'asc' ? 1 : -1;
      return 0;
    }
  
    function getSortValue(obj, key) {
      switch (key) {
        case "Name":
          return `${obj.FirstName || ""} ${obj.LastName || ""}`.toLowerCase();
        case "CustomerCreatedAt":
          return new Date(obj.CustomerCreatedAt);
        case "PlannedDate":
          return obj.PlannedDate ? new Date(obj.PlannedDate) : new Date(0);
        default:
          return obj[key] || "";
      }
    }
  </script>
  
</body>
</html>
