<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¤×¨×˜×™ ×œ×§×•×— - ×“×•×“ ×¤×¨×§×˜×™×</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="../ajaxCall.js"></script>
  <script src="../api.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#b46a2c',
            'primary-dark': '#8b5732',
            'primary-light': '#d4985a'
          },
          fontFamily: {
            'heebo': ['Heebo', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Heebo', sans-serif;
    }
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .progress-step {
      position: relative;
    }
    .progress-step::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -50%;
      width: 100%;
      height: 2px;
      background: #e5e7eb;
      z-index: -1;
    }
    .progress-step:first-child::before {
      display: none;
    }
    .progress-step.completed::before {
      background: #10b981;
    }
    .progress-step.completed .progress-circle {
      background: #10b981;
      color: white;
    }
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
    }
    @keyframes skeleton-loading {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>
</head>
<body class="bg-gray-50 font-heebo">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-lg">
      <div class="p-6">
        <div class="text-center mb-8">
          <img src="../picturs/logo.png" alt="×œ×•×’×•" class="h-20 mx-auto mb-2" />
          <h3 class="text-lg font-semibold text-gray-800">×“×•×“ ×¤×¨×§×˜×™×</h3>
          <p class="text-sm text-gray-600">××¢×¨×›×ª × ×™×”×•×œ</p>
        </div>
        <nav class="space-y-2">
          <a href="InstallerDashboard.html" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
            </svg>
            ××¡×š ×”×‘×™×ª
          </a>
          <a href="InstallerStatusesPage.html" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            ×¡×˜×˜×•×¡×™× ×œ×‘×™×¦×•×¢
          </a>
          <a href="InstallerCustomersPage.html" class="flex items-center px-4 py-3 bg-primary text-white rounded-lg">
            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
            </svg>
            ×œ×§×•×—×•×ª
          </a>
          <a href="InstallerSchedule.html" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            ×™×•××Ÿ ×”×ª×§× ×•×ª
          </a>
          <a href="BIpage.html" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            ×œ×•×— ×‘×§×¨×” - BI
          </a>
          <a href="SystemSettingsPage.html" class="flex items-center px-4 py-3 text-gray-700 rounded-lg hover:bg-gray-100 transition-colors">
            <svg class="w-5 h-5 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            ×”×’×“×¨×•×ª
          </a>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-gray-50">
      <!-- Header -->
      <header class="bg-white shadow-sm border-b border-gray-200 px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4 space-x-reverse">
            <button onclick="history.back()" class="p-2 text-gray-600 hover:text-primary hover:bg-primary/10 rounded-lg transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
            </button>
            <div>
              <h1 class="text-xl font-semibold text-gray-900">×¤×¨×˜×™ ×œ×§×•×—</h1>
              <p class="text-sm text-gray-600" id="customerNameSubtitle">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×œ×§×•×—...</p>
            </div>
          </div>
          <div class="flex items-center space-x-3 space-x-reverse">
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="p-8 space-y-8">
        <!-- Progress Bar -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-6">×”×ª×§×“××•×ª ×˜×™×¤×•×œ ×‘×œ×§×•×—</h2>
          <div class="grid grid-cols-7 gap-4" id="progressBar">
            <!-- Progress steps will be populated by JavaScript -->
          </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Customer Details -->
          <div class="lg:col-span-2 space-y-8">
            <!-- Basic Info -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-6">×¤×¨×˜×™ ×œ×§×•×—</h3>
              <div id="customerDetails" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Loading state -->
                <div class="space-y-4">
                  <div class="loading-skeleton h-4 rounded w-3/4"></div>
                  <div class="loading-skeleton h-4 rounded w-1/2"></div>
                </div>
              </div>
            </div>

            <!-- Price and Time Estimates -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6" id="estimatesSection">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">×”×¢×¨×›×•×ª ××—×™×¨ ×•×–××Ÿ</h3>
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800" id="estimateStatus">
                  ğŸ’° ××—×•×©×‘
                </span>
              </div>
              
              <div id="estimatesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Loading state -->
                <div class="space-y-4">
                  <div class="loading-skeleton h-24 rounded-lg"></div>
                </div>
                <div class="space-y-4">
                  <div class="loading-skeleton h-24 rounded-lg"></div>
                </div>
              </div>
              
              <!-- Estimate Details -->
              <div id="estimateDetails" class="mt-6 hidden">
                <div class="bg-gray-50 rounded-lg p-4">
                  <h4 class="text-sm font-medium text-gray-700 mb-3">×¤×¨×˜×™ ×”×”×¢×¨×›×”</h4>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                      <span class="text-gray-600">×©×˜×— ×›×•×œ×œ:</span>
                      <span id="estimateTotalArea" class="font-medium mr-2">-</span>
                    </div>
                    <div>
                      <span class="text-gray-600">×¡×•×’ ×¤×¨×§×˜:</span>
                      <span id="estimateParquetType" class="font-medium mr-2">-</span>
                    </div>
                    <div>
                      <span class="text-gray-600">××¡×¤×¨ ×—×“×¨×™×:</span>
                      <span id="estimateRoomCount" class="font-medium mr-2">-</span>
                    </div>
                  </div>
                  <div class="mt-3">
                    <span class="text-gray-600">×”×¢×¨×•×ª:</span>
                    <span id="estimateNotes" class="font-medium mr-2">-</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Space Details -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-6">×¤×¨×˜×™ ×”×—×œ×œ×™× ×œ×”×ª×§× ×”</h3>
              <div id="spaceDetails" class="space-y-4">
                <!-- Loading state -->
                <div class="loading-skeleton h-32 rounded"></div>
              </div>
            </div>

            <!-- Video Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6" id="videoSection">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">×¡×¨×˜×•× ×™× ×©×”×œ×§×•×— ×”×¢×œ×”</h3>
                <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800" id="videoCount">
                  ğŸ¥ 0 ×¡×¨×˜×•× ×™×
                </span>
              </div>
              
              <div id="videoContainer" class="space-y-4">
                <!-- No videos state -->
                <div id="noVideosMessage" class="text-center text-gray-500 py-8">
                  <div class="text-4xl mb-4">ğŸ¥</div>
                  <div class="text-lg font-medium text-gray-700 mb-2">×œ× × ××¦××• ×¡×¨×˜×•× ×™×</div>
                  <div class="text-sm text-gray-500">×”×œ×§×•×— ×¢×“×™×™×Ÿ ×œ× ×”×¢×œ×” ×¡×¨×˜×•× ×™×</div>
                </div>
                
                <!-- Video player with navigation -->
                <div id="videoPlayer" class="hidden">
                  <div class="relative">
                    <!-- Video element -->
                    <video id="currentVideo" controls class="w-full max-w-4xl mx-auto rounded-lg shadow-lg">
                      <source src="" type="video/mp4">
                      ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘× ×™×’×•×Ÿ ×•×™×“××•
                    </video>
                    
                    <!-- Navigation arrows -->
                    <button id="prevVideoBtn" class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all duration-200 shadow-lg">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                      </svg>
                    </button>
                    
                    <button id="nextVideoBtn" class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-50 text-white p-3 rounded-full hover:bg-opacity-70 transition-all duration-200 shadow-lg">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Video info and navigation -->
                  <div class="mt-4 text-center">
                    <div class="flex items-center justify-center space-x-4 space-x-reverse mb-4">
                      <span id="videoInfo" class="text-sm text-gray-600">×¡×¨×˜×•×Ÿ 1 ××ª×•×š 1</span>
                      <div class="flex items-center space-x-2 space-x-reverse">
                        <button onclick="playAllVideos()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                          â–¶ï¸ × ×’×Ÿ ×”×›×œ
                        </button>
                      </div>
                    </div>
                    
                    <!-- Video thumbnails -->
                    <div id="videoThumbnails" class="flex justify-center space-x-2 space-x-reverse overflow-x-auto pb-2">
                      <!-- Thumbnails will be populated by JavaScript -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sidebar -->
          <div class="space-y-8">
            <!-- Actions -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-6">×¤×¢×•×œ×•×ª</h3>
              <div class="space-y-3" id="actionsContainer">
                <!-- Actions will be populated by JavaScript -->
              </div>
            </div>

            <!-- Status Update -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-6">×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡</h3>
              <div class="space-y-4">
                <div id="statusChecklist" class="space-y-3">
                  <!-- Status checkboxes will be populated by JavaScript -->
                </div>
              </div>
            </div>



          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Quote Calculator Modal -->
  <div id="quoteCalculatorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-900">××—×©×‘×•×Ÿ ×”×¦×¢×ª ××—×™×¨</h2>
          <button onclick="closeQuoteCalculator()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="quoteCalculatorContent">
          <!-- Quote calculator content will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Create Permanent Item Modal -->
  <div id="createPermanentItemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-900">×™×¦×™×¨×ª ×¤×¨×™×˜ ×§×‘×•×¢ ×‘××—×©×‘×•×Ÿ</h2>
          <button onclick="closePermanentItemModal()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div class="space-y-4">
          <!-- Item Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">×©× ×”×¤×¨×™×˜</label>
            <input type="text" id="permanentItemName" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700">
          </div>
          
          <!-- Price -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">××—×™×¨ ××•×¦×¢ (â‚ª)</label>
            <input type="number" id="permanentItemPrice" step="0.01" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
          </div>
          
          <!-- Description -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">×ª×™××•×¨ ×”×¤×¨×™×˜</label>
            <textarea id="permanentItemDescription" rows="3" placeholder="×”×–×Ÿ ×ª×™××•×¨ ×¢×‘×•×¨ ×”×¤×¨×™×˜..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary resize-none"></textarea>
          </div>
          
          <!-- Usage Stats (if exists) -->
          <div id="usageStatsSection" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="flex items-center">
              <svg class="w-4 h-4 text-blue-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <span class="text-sm text-blue-800 font-medium" id="usageStatsText">× ×ª×•× ×™× ×¡×˜×˜×™×¡×˜×™×™×</span>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center gap-3 mt-6">
          <button onclick="confirmCreatePermanentItem()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium shadow-md">
            âœ“ ×¦×•×¨ ×¤×¨×™×˜ ×§×‘×•×¢
          </button>
          <button onclick="closePermanentItemModal()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
            ×‘×™×˜×•×œ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notifications container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <script>
    // Global variables
    let currentCustomerID = null;
    let currentRequestID = null;
    let customerData = null;
    let calculatorItems = [];
    let existingQuotes = [];
    let parquetTypes = [];
    let customItems = []; // Store custom items added to quote
    let customerVideos = []; // Store customer videos
    let currentVideoIndex = 0; // Current video being displayed
    let priceEstimate = null; // Store customer price estimate
    let availableStatuses = [
      "×¦×¤×™×™×” ×‘×¡×¨×˜×•×Ÿ ×œ×§×•×—",
      "×˜×™×•×˜×” ×œ×”×¦×¢×ª ××—×™×¨", 
      "×©×œ×™×—×ª ×˜×™×•×˜×” ×œ×œ×§×•×—",
      "×”×¢×‘×¨×ª ××§×“××”",
      "×ª×•×××” ×”×ª×§× ×”",
      "×”×ª×§× ×” ×‘×•×¦×¢×”",
      "×§×‘×œ×ª ××©×•×‘"
    ];

    // Initialize page
    $(document).ready(function() {
      const urlParams = new URLSearchParams(window.location.search);
      currentCustomerID = parseInt(urlParams.get('id'));
      
      if (!currentCustomerID) {
        showToast('×œ× × ××¦× ××–×”×” ×œ×§×•×— ×‘×›×ª×•×‘×ª', 'error');
        setTimeout(() => window.location.href = 'InstallerCustomersPage.html', 2000);
        return;
      }
      
      loadWorkRequestStatuses();
      loadParquetTypes();
      loadCustomerData();
      loadCustomerVideos();
    });

    // Load work request statuses from server
    function loadWorkRequestStatuses() {
      ajaxCall('GET', `${API_BASE_URL}/BI/GetWorkRequestStatuses`, null,
        function(statuses) {
          if (Array.isArray(statuses)) {
            // Fix old status names from server
            availableStatuses = statuses.map(s => {
              let statusName = s.statusName;
              // Fix the old status name
              if (statusName === '×ª×™××•× ×”×ª×§× ×”') {
                statusName = '×ª×•×××” ×”×ª×§× ×”';
              }
              return statusName;
            });
          }
        },
        function(error) {
          console.warn('Could not load statuses from server, using defaults');
        }
      );
    }

    // Load parquet types from server
    function loadParquetTypes() {
      ajaxCall('GET', `${API_BASE_URL}/ParquetType/GetAll`, null,
        function(types) {
          if (Array.isArray(types)) {
            parquetTypes = types;
            console.log('âœ… Loaded parquet types:', parquetTypes);
          } else {
            console.error('âŒ Invalid parquet types data received:', types);
          }
        },
        function(error) {
          console.error('Error loading parquet types:', error);
          // Fallback to static data
          parquetTypes = [
            { typeName: 'SPC/×œ××™× ×¦×™×”', pricePerUnit: 60, type: 'spc', parquetTypeID: 'spc' },
            { typeName: '×¢×¥', pricePerUnit: 85, type: 'wood', parquetTypeID: 'wood' },
            { typeName: '×¤×™×©×‘×•×Ÿ', pricePerUnit: 150, type: 'fishbone', parquetTypeID: 'fishbone' }
          ];
        }
      );
    }

    // Load customer data
    function loadCustomerData() {
      ajaxCall('GET', `${API_BASE_URL}/CustomerDetails/GetCustomerDetails/${currentCustomerID}`, null,
        function(data) {
          if (data && data.customer && data.workRequest) {
            customerData = data;
            currentRequestID = data.workRequest.requestID;
            
            // Fix old status name from server
            if (customerData.workRequest.status === '×ª×™××•× ×”×ª×§× ×”') {
              customerData.workRequest.status = '×ª×•×××” ×”×ª×§× ×”';
            }
            
            renderCustomerDetails(data);
            renderSpaceDetails(data.spaceDetails);
            renderProgressBar(data.workRequest.status, false); // No animation on initial load
            renderStatusChecklist(data.workRequest.status);
            loadExistingQuotes();
            loadPriceEstimate(); // Load price and time estimates
            
            // Update page title
            document.getElementById('customerNameSubtitle').textContent = 
              `${data.customer.firstName} ${data.customer.lastName}`;
          } else {
            console.error('Invalid customer data received:', data);
            showToast(data?.message || '×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×œ×§×•×—', 'error');
          }
        },
        function(error) {
          console.error('Error loading customer data:', error);
          showToast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×œ×§×•×—', 'error');
        }
      );
    }

    // Render customer details
    function renderCustomerDetails(data) {
      const container = document.getElementById('customerDetails');
      
      // Format installation date
      const installationDate = data.workRequest.scheduledDate 
        ? new Date(data.workRequest.scheduledDate).toLocaleDateString('he-IL')
        : '×˜×¨× × ×§×‘×¢ ×ª××¨×™×š';
      
      container.innerHTML = `
        <div class="space-y-6">
          <!-- Customer Name - Larger and prominent -->
          <div class="border-b border-gray-200 pb-4">
            <div class="text-2xl font-bold text-gray-900" id="customerName">
              ${data.customer.firstName} ${data.customer.lastName}
            </div>
          </div>
          
          <!-- Contact Info -->
          <div class="space-y-4">
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                ×˜×œ×¤×•×Ÿ
              </label>
              <div class="text-gray-900 text-lg" id="customerPhone">${data.customer.phone || '-'}</div>
            </div>
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
                ××™××™×™×œ
              </label>
              <div class="text-gray-900" id="customerEmail">${data.customer.email || '-'}</div>
            </div>
          </div>
        </div>
        
        <div class="space-y-6">
          <!-- Address -->
          <div class="space-y-4">
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                ×¢×™×¨
              </label>
              <div class="text-gray-900" id="customerCity">${data.customer.city || '-'}</div>
            </div>
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                ×¨×—×•×‘ ×•××¡×¤×¨
              </label>
              <div class="text-gray-900" id="customerAddress">
                ${data.customer.street || ''} ${data.customer.number || ''}
              </div>
            </div>
          </div>
          
          <!-- Status and Dates -->
          <div class="space-y-4">
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                ×¡×˜×˜×•×¡
              </label>
              <div class="inline-flex px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800" id="customerStatus">
                ${data.workRequest.status || '-'}
              </div>
            </div>
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                ×ª××¨×™×š ××•×¢×“×£
              </label>
              <div class="text-gray-900" id="preferredDate">
                ${data.workRequest.preferredDate ? new Date(data.workRequest.preferredDate).toLocaleDateString('he-IL') : '-'}
              </div>
            </div>
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                ×ª××¨×™×š ×”×ª×§× ×” ×©× ×§×‘×¢
              </label>
              <div class="text-gray-900 ${installationDate === '×˜×¨× × ×§×‘×¢ ×ª××¨×™×š' ? 'text-amber-600 font-medium' : 'font-semibold'}" id="scheduledDate">
                ${installationDate}
              </div>
            </div>
            <div>
              <label class="flex items-center text-sm font-bold text-gray-800 mb-2">
                <svg class="w-4 h-4 text-gray-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                ×”×¢×¨×•×ª
              </label>
              <div class="text-gray-900" id="customerNotes">${data.customer.notes || '××™×Ÿ ×”×¢×¨×•×ª'}</div>
            </div>
          </div>
        </div>
      `;
    }

    // Render space details
    function renderSpaceDetails(spaces) {
      const container = document.getElementById('spaceDetails');
      
      if (!spaces || spaces.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-center py-8">×œ× × ××¦××• ×¤×¨×˜×™ ×—×œ×œ×™×</div>';
        return;
      }

      const totalArea = spaces.reduce((sum, space) => sum + (space.size || 0), 0);

      container.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-gray-50">
                <th class="text-right px-4 py-3 text-sm font-medium text-gray-700 border-b">#</th>
                <th class="text-right px-4 py-3 text-sm font-medium text-gray-700 border-b">×¡×•×’ ×—×œ×œ</th>
                <th class="text-right px-4 py-3 text-sm font-medium text-gray-700 border-b">×¡×•×’ ×¤×¨×§×˜</th>
                <th class="text-right px-4 py-3 text-sm font-medium text-gray-700 border-b">×©×˜×— (×"×¨)</th>
                <th class="text-right px-4 py-3 text-sm font-medium text-gray-700 border-b">×”×¢×¨×•×ª</th>
              </tr>
            </thead>
            <tbody>
              ${spaces.map((space, index) => `
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm text-gray-900 border-b">${index + 1}</td>
                  <td class="px-4 py-3 text-sm text-gray-900 border-b">${space.floorType || '-'}</td>
                  <td class="px-4 py-3 text-sm text-gray-900 border-b">${space.parquetType || '-'}</td>
                  <td class="px-4 py-3 text-sm text-gray-900 border-b">${space.size || 0} ×"×¨</td>
                  <td class="px-4 py-3 text-sm text-gray-900 border-b">${space.notes || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr class="bg-gray-50">
                <td colspan="3" class="px-4 py-3 text-sm font-semibold text-gray-900 border-t">×¡×”"×› ×©×˜×—:</td>
                <td class="px-4 py-3 text-sm font-semibold text-gray-900 border-t">${totalArea.toFixed(2)} ×"×¨</td>
                <td class="px-4 py-3 border-t"></td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    }

    // Render progress bar
    function renderProgressBar(currentStatus, animate = true) {
      const container = document.getElementById('progressBar');
      const currentIndex = availableStatuses.indexOf(currentStatus);
      
      const newHTML = availableStatuses.map((status, index) => {
        const isCompleted = index <= currentIndex;
        const isCurrent = index === currentIndex;
        
        return `
          <div class="progress-step text-center ${isCompleted ? 'completed' : ''} ${animate ? 'transition-all duration-500' : ''}" data-step="${index}">
            <div class="progress-circle w-10 h-10 rounded-full border-2 flex items-center justify-center text-sm font-semibold mx-auto mb-2 transition-all duration-500 ${
              isCompleted 
                ? 'bg-green-500 border-green-500 text-white shadow-lg transform scale-110' 
                : 'bg-white border-gray-300 text-gray-600'
            } ${isCurrent ? 'ring-4 ring-green-200 ring-opacity-75' : ''}">
              ${isCompleted ? 'âœ“' : index + 1}
            </div>
            <div class="text-xs leading-tight transition-colors duration-300 ${
              isCompleted ? 'text-green-700 font-medium' : 'text-gray-600'
            }">${status}</div>
            ${isCurrent ? '<div class="mt-1 w-2 h-2 bg-green-500 rounded-full mx-auto animate-pulse"></div>' : ''}
          </div>
        `;
      }).join('');
      
      container.innerHTML = newHTML;
      
             // Add celebration effect for completion
       if (animate && currentIndex === availableStatuses.length - 1) {
         setTimeout(() => {
           showToast('×›×œ ×”×©×œ×‘×™× ×”×•×©×œ××• ×‘×”×¦×œ×—×”! ×”×ª×”×œ×™×š ×”×¡×ª×™×™×.', 'success');
         }, 600);
       }
    }

    // Render status checklist
    function renderStatusChecklist(currentStatus) {
      const container = document.getElementById('statusChecklist');
      const currentIndex = availableStatuses.indexOf(currentStatus);
      
      container.innerHTML = availableStatuses.map((status, index) => {
        const isCompleted = index <= currentIndex;
        const isCurrent = index === currentIndex;
        const canNavigateTo = true; // All statuses are clickable now
        
        let statusIcon = '';
        let statusDescription = '';
        
                 if (isCompleted && !isCurrent) {
           statusIcon = 'â€¢';
           statusDescription = '×”×•×©×œ×';
         } else if (isCurrent) {
           statusIcon = 'â†’';
           statusDescription = '× ×•×›×—×™';
         } else {
           statusIcon = 'â€¢';
           statusDescription = '×××ª×™×Ÿ';
         }
        
                 return `
           <label class="group flex items-center justify-between p-4 rounded-xl border-2 shadow-sm ${
             isCompleted ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 hover:from-green-100 hover:to-emerald-100 hover:shadow-md' : 'bg-gradient-to-r from-white to-gray-50 border-gray-200 hover:from-blue-50 hover:to-indigo-50 hover:border-blue-300 hover:shadow-md'
           } cursor-pointer transition-all duration-300 transform hover:scale-[1.02] ${isCurrent ? 'ring-2 ring-primary ring-opacity-50 shadow-lg' : ''}">
             <div class="flex items-center gap-6">
               <div class="relative">
                 <input 
                   type="checkbox" 
                   ${isCompleted ? 'checked' : ''} 
                   onchange="updateStatusToLevel('${status}', ${index})"
                   class="sr-only"
                 >
                 <div class="w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all duration-200 ${
                   isCompleted 
                     ? 'bg-gradient-to-br from-green-400 to-green-600 border-green-500 text-white shadow-lg' 
                     : 'bg-white border-gray-300 group-hover:border-blue-400 group-hover:shadow-sm'
                 }">
                   ${isCompleted ? '<span class="text-xs font-bold">âœ“</span>' : ''}
                 </div>
               </div>
               <div class="flex flex-col">
                 <span class="text-base font-medium ${isCompleted ? 'text-green-800' : 'text-gray-700'} group-hover:text-gray-900 transition-colors">${status}</span>
               </div>
             </div>
             <div class="flex items-center space-x-3">
               <span class="text-xs px-3 py-1 rounded-full font-medium shadow-sm ${
                 isCompleted ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-gray-100 text-gray-600 border border-gray-200'
               } transition-all duration-200">${statusDescription}</span>
               <span class="text-xl transition-transform duration-200 group-hover:scale-110">${statusIcon}</span>
             </div>
           </label>
         `;
      }).join('');
      
      // Add instructions for user
      const instructionsHTML = `
        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
            </div>
                         <div class="mr-3">
               <p class="text-sm text-blue-700">
                 <strong>×˜×™×¤:</strong> ×œ×—×¥ ×¢×œ ×›×œ ×¡×˜×˜×•×¡ ×›×“×™ ×œ×¢×“×›×Ÿ ××ª ×”×”×ª×§×“××•×ª. ×›×œ ×”×©×œ×‘×™× ×¢×“ ×”× ×§×•×“×” ×”× ×‘×—×¨×ª ×™×¡×•×× ×• ×›×”×•×©×œ××•.
               </p>
             </div>
          </div>
        </div>
      `;
      
      container.innerHTML += instructionsHTML;
    }

    // Load existing quotes
    function loadExistingQuotes() {
      ajaxCall('GET', `${API_BASE_URL}/Quote/GetCustomerQuotes/${currentCustomerID}`, null,
        function(quotes) {
          existingQuotes = quotes || [];
          // Update action buttons based on quotes existence
          updateActionButtons();
        },
        function(error) {
          console.error('Error loading quotes:', error);
          existingQuotes = [];
          updateActionButtons();
        }
      );
    }

    // Update action buttons based on existing quotes
    function updateActionButtons() {
      const container = document.getElementById('actionsContainer');
      const hasQuotes = existingQuotes.length > 0;
      
      container.innerHTML = `
        <!-- Create Quote Button -->
        <button onclick="${hasQuotes ? '' : 'openQuoteCalculator()'}" 
                class="w-full px-4 py-3 rounded-lg transition-colors ${
                  hasQuotes 
                    ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                    : 'bg-primary text-white hover:bg-primary-dark'
                }"
                ${hasQuotes ? 'disabled' : ''}>
          <span class="flex items-center justify-center">
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            ×™×¦×™×¨×ª ×”×¦×¢×ª ××—×™×¨
          </span>
        </button>

        <!-- View/Edit Quote Button -->
        <button onclick="${hasQuotes ? 'viewEditQuote()' : ''}" 
                class="w-full px-4 py-3 rounded-lg transition-colors ${
                  hasQuotes 
                    ? 'bg-blue-600 text-white hover:bg-blue-700' 
                    : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                }"
                ${hasQuotes ? '' : 'disabled'}>
          <span class="flex items-center justify-center">
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            ×¦×¤×™×™×” ×•×¢×¨×™×›×ª ×”×¦×¢×ª ××—×™×¨
          </span>
        </button>

        <!-- Back to Customers Button -->
        <button onclick="window.location.href='InstallerCustomersPage.html'" 
                class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
          <span class="flex items-center justify-center">
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
            </svg>
            ×—×–×•×¨ ×œ×¨×©×™××ª ×œ×§×•×—×•×ª
          </span>
        </button>
      `;
    }



    // Update status to specific level
    function updateStatusToLevel(targetStatus, targetIndex) {
      const currentIndex = availableStatuses.indexOf(customerData.workRequest.status);
      const isMovingForward = targetIndex > currentIndex;
      const isMovingBackward = targetIndex < currentIndex;
      
      console.log(`ğŸ¯ ×¢×•×“×›×Ÿ ×¡×˜×˜×•×¡ ×œ×¨××”: ${targetStatus} (××™× ×“×§×¡ ${targetIndex})`);
      
      // Show confirmation for moving backward
      if (isMovingBackward) {
        const confirmMessage = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×—×–×•×¨ ×"${customerData.workRequest.status}" ×œ"${targetStatus}"?`;
        if (!confirm(confirmMessage)) {
          // Revert the checkbox
          renderStatusChecklist(customerData.workRequest.status);
          return;
        }
      }
      
      const oldStatus = customerData.workRequest.status;
      
      ajaxCall('POST', `${API_BASE_URL}/CustomerDetails/UpdateWorkRequestStatus`, 
        JSON.stringify({ requestID: currentRequestID, newStatus: targetStatus }), 
        function(result) {
          if (result && result.success) {
            customerData.workRequest.status = targetStatus;
            renderProgressBar(targetStatus);
            renderStatusChecklist(targetStatus);
            
            // Show detailed message based on action type
            let message = '';
            const completedSteps = targetIndex + 1;
            const totalSteps = availableStatuses.length;
            
                        if (isMovingForward) {
               message = `×¢×‘×¨×ª ×œ"${targetStatus}"`;
             } else if (isMovingBackward) {
               message = `×—×–×¨×ª ×œ"${targetStatus}"`;
             } else {
               message = `×¡×˜×˜×•×¡ "${targetStatus}"`;
             }
            
            showToast(message, 'info');
            
                         // Show completion celebration
             if (targetIndex === totalSteps - 1 && isMovingForward) {
               setTimeout(() => {
                 showToast('××–×œ ×˜×•×‘! ×›×œ ×”×©×œ×‘×™× ×”×•×©×œ××• ×‘×”×¦×œ×—×”!', 'success');
               }, 1000);
             }
            
          } else {
            showToast(result?.message || '×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡', 'error');
            renderStatusChecklist(customerData.workRequest.status);
          }
        },
        function(error) {
          console.error('Error updating status:', error);
          showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¡×˜×˜×•×¡', 'error');
          // Reload the checklist to revert changes
          renderStatusChecklist(customerData.workRequest.status);
        }
      );
    }

    // Legacy function for backward compatibility
    function updateStatus(newStatus, isChecked) {
      const statusIndex = availableStatuses.indexOf(newStatus);
      if (statusIndex !== -1) {
        updateStatusToLevel(newStatus, statusIndex);
      }
    }

    // Open quote calculator
    function openQuoteCalculator() {
      // Check if quotes already exist - prevent opening for new quote creation
      if (existingQuotes && existingQuotes.length > 0) {
        showToast('×™×© ×›×‘×¨ ×”×¦×¢×ª ××—×™×¨ ×¢×‘×•×¨ ×”×œ×§×•×—. ×”×©×ª××© ×‘"×¦×¤×™×™×” ×•×¢×¨×™×›×”" ×‘××§×•×', 'warning');
        return;
      }
      
      // Clear custom items when opening new calculator
      customItems = [];
      const modal = document.getElementById('quoteCalculatorModal');
      if (modal) {
        modal.classList.remove('hidden');
        loadQuoteCalculator();
      } else {
        console.error('Quote calculator modal not found!');
        showToast('×©×’×™××” ×‘×¤×ª×™×—×ª ××—×©×‘×•×Ÿ ×”×¦×¢×ª ××—×™×¨', 'error');
      }
    }

    // Close quote calculator
    function closeQuoteCalculator() {
      // Clear custom items when closing calculator
      customItems = [];
      const modal = document.getElementById('quoteCalculatorModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // Load quote calculator content
    function loadQuoteCalculator() {
      const container = document.getElementById('quoteCalculatorContent');
      const totalArea = customerData.spaceDetails.reduce((sum, space) => sum + (space.size || 0), 0);
      
      container.innerHTML = `
        <div class="space-y-6">
          <!-- Floor Selection -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">×¤×¨×˜×™ ×¤×¨×§×˜ ×‘×¡×™×¡×™</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">×¡×•×’ ×¤×¨×§×˜</label>
                <select id="floorType" onchange="updateFloorPrice()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                  <option value="spc">SPC/×œ××™× ×¦×™×”</option>
                  <option value="wood">×¢×¥</option>
                  <option value="fishbone">×¤×™×©×‘×•×Ÿ</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">××—×™×¨ ×œ×"×¨</label>
                <input type="number" id="floorPricePerMeter" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">×¡×”"×› ×©×˜×—</label>
                <input type="number" id="totalArea" value="${totalArea}" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg">
              </div>
            </div>
            <div class="mt-4">
              <label class="flex items-center">
                <input type="checkbox" id="includeBaseFloor" checked class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                <span class="text-sm font-medium text-gray-700">×›×œ×•×œ ×¤×¨×§×˜ ×‘×¡×™×¡×™ ×‘×”×¦×¢×”</span>
              </label>
            </div>
          </div>

          <!-- Calculator Items -->
          <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-4">×¤×¨×™×˜×™× × ×•×¡×¤×™×</h3>
            <div id="calculatorItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- Calculator items will be loaded here -->
            </div>
            
            <!-- Add Custom Item -->
            <div class="mt-6 border-2 border-dashed border-gray-300 rounded-lg p-6">
              <h4 class="text-md font-medium text-gray-900 mb-4">×”×•×¡×£ ×¤×¨×™×˜ ××•×ª×× ××™×©×™×ª</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative">
                  <label class="block text-sm font-medium text-gray-700 mb-2">×©× ×”×¤×¨×™×˜</label>
                  <input type="text" id="customItemName" placeholder="×”×§×œ×“ ×©× ×¤×¨×™×˜..." 
                         oninput="showItemSuggestions(this.value)" onblur="setTimeout(hideSuggestions, 200)"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                  <div id="itemSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto">
                    <!-- Suggestions will appear here -->
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">××—×™×¨ ×œ×™×—×™×“×” (â‚ª)</label>
                  <input type="number" id="customItemPrice" placeholder="0" min="0" step="0.01"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">×›××•×ª</label>
                  <div class="flex items-center space-x-2">
                    <button onclick="adjustCustomQuantity(-1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">-</button>
                    <span id="customItemQuantity" class="w-8 text-center font-medium">1</span>
                    <button onclick="adjustCustomQuantity(1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">+</button>
                  </div>
                </div>
              </div>
              <div class="mt-4 flex justify-center gap-3">
                <button onclick="addCustomItemToQuote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                  ×”×•×¡×£ ×œ×—×™×©×•×‘
                </button>
                <button onclick="clearCustomItem()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                  × ×§×”
                </button>
              </div>
            </div>
          </div>

          <!-- Quote Preview -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">×ª×¦×•×’×” ××§×“×™××”</h3>
            <div id="quotePreview" class="space-y-2">
              <!-- Quote preview will be updated here -->
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="flex items-center justify-between mb-4">
                <label class="text-sm font-medium text-gray-700">×”× ×—×” (%)</label>
                <input type="number" id="discountPercent" value="0" min="0" max="100" onchange="calculateQuote()" class="w-20 px-2 py-1 border border-gray-300 rounded">
              </div>
              <!-- Calculate button right under discount input -->
              <div class="mb-4 flex justify-end">
                <button onclick="calculateQuote()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-sm">
                  ×—×©×‘ ××—×“×©
                </button>
              </div>
              <!-- Create quote button - centered and wider -->
              <div class="flex justify-center">
                <button onclick="createQuote()" class="px-8 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors font-medium text-lg shadow-md">
                  ×©××•×¨ ×”×¦×¢×ª ××—×™×¨
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      loadCalculatorItems();
      // Update parquet options after HTML is inserted
      setTimeout(() => {
        const floorTypeSelect = document.getElementById('floorType');
        if (floorTypeSelect) {
          floorTypeSelect.innerHTML = generateParquetOptions();
        }
        updateFloorPrice();
      }, 100);
    }



    // Load calculator items
    function loadCalculatorItems() {
      ajaxCall('GET', `${API_BASE_URL}/Quote/GetCalculatorItems`, null,
        function(items) {
          calculatorItems = items;
          renderCalculatorItems(items);
          calculateQuote();
        },
        function(error) {
          console.error('Error loading calculator items:', error);
          document.getElementById('calculatorItems').innerHTML = '<div class="text-gray-500 text-center py-4">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×™×˜×™ ××—×©×‘×•×Ÿ</div>';
        }
      );
    }

    // Render calculator items
    function renderCalculatorItems(items) {
      const container = document.getElementById('calculatorItems');
      container.innerHTML = items.map(item => `
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-item-id="${item.calculatorItemID}">
          <h4 class="font-medium text-gray-900 mb-2">${item.itemName}</h4>
          <p class="text-sm text-gray-600 mb-3">${item.description || ''}</p>
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-primary">â‚ª${item.price}</span>
            <div class="flex items-center space-x-2">
              <button onclick="adjustQuantity(${item.calculatorItemID}, -1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">-</button>
              <span id="qty_${item.calculatorItemID}" class="w-8 text-center font-medium">0</span>
              <button onclick="adjustQuantity(${item.calculatorItemID}, 1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">+</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Generate parquet type options HTML
    function generateParquetOptions() {
      if (!parquetTypes || parquetTypes.length === 0) {
        // Fallback options if data not loaded yet
        return `
          <option value="spc">SPC/×œ××™× ×¦×™×”</option>
          <option value="wood">×¢×¥</option>
          <option value="fishbone">×¤×™×©×‘×•×Ÿ</option>
        `;
      }
      
      return parquetTypes.map((parquet, index) => {
        // ×”×¨××©×•×Ÿ ×‘×¨×©×™××” ×ª××™×“ ×™×”×™×” ×‘×¨×™×¨×ª ×”××—×“×œ
        const isSelected = index === 0;
        return `<option value="${parquet.parquetTypeID}" ${isSelected ? 'selected' : ''}>${parquet.typeName}</option>`;
      }).join('');
    }

    // Show item suggestions for custom item (now using smart API)
    function showItemSuggestions(query) {
      const suggestionsContainer = document.getElementById('itemSuggestions');
      
      if (!query || query.length < 2) {
        suggestionsContainer.classList.add('hidden');
        return;
      }
      
      // Show loading state
      suggestionsContainer.innerHTML = `
        <div class="px-4 py-2 text-center text-gray-500">
          <div class="text-sm">×˜×•×¢×Ÿ ×”×¦×¢×•×ª...</div>
        </div>
      `;
      suggestionsContainer.classList.remove('hidden');
      
      // Get smart suggestions from API
      ajaxCall('GET', `${API_BASE_URL}/PriceCalculatorItem/GetItemSuggestions?query=${encodeURIComponent(query)}&maxResults=8`, null,
        function(suggestions) {
          if (!suggestions || suggestions.length === 0) {
            suggestionsContainer.classList.add('hidden');
            return;
          }
          
          suggestionsContainer.innerHTML = suggestions.map(suggestion => `
            <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0" 
                 onclick="selectSuggestedItem('${suggestion.suggestionText}', ${suggestion.suggestedPrice})">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="font-medium text-gray-900">${suggestion.suggestionText}</div>
                  <div class="text-xs text-gray-600">â‚ª${suggestion.suggestedPrice.toFixed(2)}</div>
                </div>
                <div class="flex items-center">
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                    suggestion.source === '×§×‘×•×¢' 
                      ? 'bg-green-100 text-green-800' 
                      : 'bg-yellow-100 text-yellow-800'
                  }">
                    ${suggestion.source === '×§×‘×•×¢' ? 'ğŸ”§ ×§×‘×•×¢' : 'ğŸ’¡ ××•×¦×¢'}
                  </span>
                </div>
              </div>
            </div>
          `).join('');
        },
        function(error) {
          console.error('Error getting item suggestions:', error);
          suggestionsContainer.classList.add('hidden');
        }
      );
    }

    // Hide suggestions
    function hideSuggestions() {
      const suggestionsContainer = document.getElementById('itemSuggestions');
      suggestionsContainer.classList.add('hidden');
    }

    // Select suggested item
    function selectSuggestedItem(itemName, price) {
      document.getElementById('customItemName').value = itemName;
      document.getElementById('customItemPrice').value = price;
      hideSuggestions();
    }

    // Adjust custom item quantity
    function adjustCustomQuantity(delta) {
      const qtyElement = document.getElementById('customItemQuantity');
      const currentQty = parseInt(qtyElement.textContent) || 1;
      const newQty = Math.max(1, currentQty + delta);
      qtyElement.textContent = newQty;
    }

    // Add custom item to quote
    function addCustomItemToQuote() {
      const itemName = document.getElementById('customItemName').value.trim();
      const itemPrice = parseFloat(document.getElementById('customItemPrice').value) || 0;
      const itemQuantity = parseInt(document.getElementById('customItemQuantity').textContent) || 1;
      
      if (!itemName) {
        showToast('× × ×œ×”×–×™×Ÿ ×©× ×¤×¨×™×˜', 'error');
        return;
      }
      
      if (itemPrice <= 0) {
        showToast('× × ×œ×”×–×™×Ÿ ××—×™×¨ ×ª×§×™×Ÿ', 'error');
        return;
      }
      
      // Add to custom items array
      const customItem = {
        id: Date.now(), // Unique ID for custom items
        itemName: itemName,
        price: itemPrice,
        quantity: itemQuantity,
        isCustom: true
      };
      
      customItems.push(customItem);
      
      // Render the custom item in the calculator area
      renderCustomItem(customItem);
      
      // Clear the form
      clearCustomItem();
      
      // Recalculate quote
      calculateQuote();
      
      showToast(`×¤×¨×™×˜ "${itemName}" × ×•×¡×£ ×œ×—×™×©×•×‘`, 'success');
    }

    // Render custom item in calculator
    function renderCustomItem(item) {
      const calculatorContainer = document.getElementById('calculatorItems');
      const customItemHTML = `
        <div class="border border-blue-200 bg-blue-50 rounded-lg p-4 hover:shadow-md transition-shadow" data-custom-item-id="${item.id}">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-medium text-gray-900">${item.itemName}</h4>
            <button onclick="removeCustomItem(${item.id})" class="text-red-500 hover:text-red-700 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <p class="text-sm text-blue-600 mb-3">×¤×¨×™×˜ ××•×ª×× ××™×©×™×ª</p>
          <div class="flex items-center justify-between mb-3">
            <span class="text-sm font-medium text-primary">â‚ª${item.price}</span>
            <div class="flex items-center space-x-2">
              <button onclick="adjustCustomItemQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">-</button>
              <span id="custom_qty_${item.id}" class="w-8 text-center font-medium">${item.quantity}</span>
              <button onclick="adjustCustomItemQuantity(${item.id}, 1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">+</button>
            </div>
          </div>
        </div>
      `;
      
      calculatorContainer.insertAdjacentHTML('beforeend', customItemHTML);
    }

    // Adjust custom item quantity in calculator
    function adjustCustomItemQuantity(itemId, delta) {
      const qtyElement = document.getElementById(`custom_qty_${itemId}`);
      const currentQty = parseInt(qtyElement.textContent) || 1;
      const newQty = Math.max(0, currentQty + delta);
      
      // Update in DOM
      qtyElement.textContent = newQty;
      
      // Update in array
      const item = customItems.find(i => i.id === itemId);
      if (item) {
        item.quantity = newQty;
        
        // If quantity is 0, remove the item
        if (newQty === 0) {
          removeCustomItem(itemId);
          return;
        }
      }
      
      // Recalculate quote
      calculateQuote();
    }

    // Remove custom item
    function removeCustomItem(itemId) {
      // Remove from array
      customItems = customItems.filter(item => item.id !== itemId);
      
      // Remove from DOM
      const itemElement = document.querySelector(`[data-custom-item-id="${itemId}"]`);
      if (itemElement) {
        itemElement.remove();
      }
      
      // Recalculate quote
      calculateQuote();
      
      showToast('×¤×¨×™×˜ ×”×•×¡×¨ ××”×—×™×©×•×‘', 'info');
    }

    // Clear custom item form
    function clearCustomItem() {
      document.getElementById('customItemName').value = '';
      document.getElementById('customItemPrice').value = '';
      document.getElementById('customItemQuantity').textContent = '1';
    }

    // Update floor price based on selection
    function updateFloorPrice() {
      const floorTypeElement = document.getElementById('floorType');
      if (!floorTypeElement) return;
      
      const selectedValue = floorTypeElement.value;
      const selectedParquet = parquetTypes.find(p => p.parquetTypeID == selectedValue || p.type == selectedValue);
      
      if (selectedParquet) {
        document.getElementById('floorPricePerMeter').value = selectedParquet.pricePerUnit;
      } else {
        document.getElementById('floorPricePerMeter').value = 60; // fallback
      }
      
      calculateQuote();
    }

    // Adjust item quantity
    function adjustQuantity(itemId, delta) {
      const qtyElement = document.getElementById(`qty_${itemId}`);
      const currentQty = parseInt(qtyElement.textContent) || 0;
      const newQty = Math.max(0, currentQty + delta);
      qtyElement.textContent = newQty;
      calculateQuote();
    }

    // Calculate quote
    function calculateQuote() {
      const data = gatherQuoteData();
      console.log('ğŸ“Š × ×ª×•× ×™ ×”×”×¦×¢×” ×©× ×©×œ×—×™× ×œ×©×¨×ª:', data);
      
      ajaxCall('POST', `${API_BASE_URL}/Quote/CalculateQuote`, JSON.stringify(data),
        function(result) {
          if (result && (result.subtotal !== undefined || result.items)) {
            displayQuotePreview(result);
          } else {
            console.error('Invalid quote calculation result:', result);
            showToast(result?.message || '×©×’×™××” ×‘×—×™×©×•×‘ ×”×¦×¢×ª ×”××—×™×¨', 'error');
          }
        },
        function(error) {
          console.error('Error calculating quote:', error);
          showToast('×©×’×™××” ×‘×—×™×©×•×‘ ×”×¦×¢×ª ×”××—×™×¨', 'error');
        }
      );
    }

    // Gather quote data
    function gatherQuoteData() {
      const items = [];
      
      // Get all calculator items with quantities > 0
      document.querySelectorAll('[id^="qty_"]').forEach(element => {
        const itemId = parseInt(element.id.replace('qty_', ''));
        const quantity = parseInt(element.textContent) || 0;
        if (quantity > 0) {
          const item = calculatorItems.find(i => i.calculatorItemID === itemId);
          if (item) {
            items.push({
              CalculatorItemID: itemId,
              ItemName: item.itemName,
              UnitPrice: item.price,
              Quantity: quantity,
              Notes: ""
            });
          }
        }
      });

      // Add custom items with quantities > 0
      customItems.forEach(customItem => {
        if (customItem.quantity > 0) {
          items.push({
            CalculatorItemID: null, // Custom items don't have calculator item ID
            ItemName: customItem.itemName,
            UnitPrice: customItem.price,
            Quantity: customItem.quantity,
            Notes: "×¤×¨×™×˜ ××•×ª×× ××™×©×™×ª"
          });
        }
      });

      return {
        RequestID: currentRequestID,
        IncludeBaseFloor: document.getElementById('includeBaseFloor').checked,
        TotalArea: parseFloat(document.getElementById('totalArea').value) || 0,
        FloorType: document.getElementById('floorType').value,
        FloorPricePerMeter: parseFloat(document.getElementById('floorPricePerMeter').value) || 0,
        DiscountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
        Items: items
      };
    }

    // Display quote preview
    function displayQuotePreview(quote) {
      const container = document.getElementById('quotePreview');
      container.innerHTML = `
        <div class="space-y-2">
          ${quote.items.map(item => `
            <div class="flex justify-between text-sm">
              <span>${item.itemName} (${item.quantity}x)</span>
              <span>â‚ª${item.totalPrice.toFixed(2)}</span>
            </div>
          `).join('')}
        </div>
        <div class="pt-2 border-t border-gray-300 space-y-1">
          <div class="flex justify-between text-sm">
            <span>×¡×”"×› ×œ×¤× ×™ ×”× ×—×”:</span>
            <span>â‚ª${quote.subtotal.toFixed(2)}</span>
          </div>
          ${quote.discountAmount > 0 ? `
          <div class="flex justify-between text-sm text-red-600">
            <span>×”× ×—×” (${quote.discountPercent}%):</span>
            <span>-â‚ª${quote.discountAmount.toFixed(2)}</span>
          </div>
          ` : ''}
          <div class="flex justify-between text-sm">
            <span>×œ××—×¨ ×”× ×—×”:</span>
            <span>â‚ª${quote.afterDiscount.toFixed(2)}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span>××¢"× (${quote.vatPercent}%):</span>
            <span>â‚ª${quote.vatAmount.toFixed(2)}</span>
          </div>
          <div class="flex justify-between text-lg font-semibold border-t border-gray-300 pt-2">
            <span>×¡×”"×› ×œ×ª×©×œ×•×:</span>
            <span class="text-primary">â‚ª${quote.finalTotal.toFixed(2)}</span>
          </div>
        </div>
      `;
    }

    // Create quote
    function createQuote() {
      // Check if quotes already exist - prevent duplicate creation
      if (existingQuotes && existingQuotes.length > 0) {
        showToast('×™×© ×›×‘×¨ ×”×¦×¢×ª ××—×™×¨ ×¢×‘×•×¨ ×”×œ×§×•×—. ×”×©×ª××© ×‘"×¦×¤×™×™×” ×•×¢×¨×™×›×”" ×‘××§×•×', 'warning');
        return;
      }
      
      const data = gatherQuoteData();
      
      // Check for popular candidates before saving quote
      checkForPopularCandidatesBeforeSave(data);
    }
    
    // Check for popular candidates in custom items before saving quote
    function checkForPopularCandidatesBeforeSave(quoteData, isUpdate = false) {
      // Extract custom items (items without calculatorItemID) 
      const customItems = quoteData.Items.filter(item => 
        !item.CalculatorItemID && item.Quantity > 0
      );
      
      if (customItems.length === 0) {
        // No custom items, save directly
        saveQuoteDirectly(quoteData, isUpdate);
        return;
      }
      
      console.log('ğŸ” ×‘×•×“×§ ××•×¢××“×™× ×¤×•×¤×•×œ×¨×™×™× ×¢×‘×•×¨ ×¤×¨×™×˜×™× ××•×ª×××™×:', customItems);
      
      // Get popular candidates
      ajaxCall('GET', `${API_BASE_URL}/PriceCalculatorItem/GetPopularCandidates`, null,
        function(candidates) {
          // Find which custom items are popular candidates
          const popularCustomItems = customItems.filter(customItem => 
            candidates.some(candidate => candidate.customItemName === customItem.ItemName)
          );
          
          if (popularCustomItems.length > 0) {
            // Show suggestion dialog for popular items
            showPopularCandidatesDialog(popularCustomItems, candidates, quoteData, isUpdate);
          } else {
            // No popular candidates found, save directly
            console.log('ğŸ“ ×œ× × ××¦××• ××•×¢××“×™× ×¤×•×¤×•×œ×¨×™×™×, ×©×•××¨ ×”×¦×¢×” ×™×©×™×¨×•×ª');
            saveQuoteDirectly(quoteData, isUpdate);
          }
        },
        function(error) {
          console.error('Error checking candidates:', error);
          // On error, save directly
          saveQuoteDirectly(quoteData, isUpdate);
        }
      );
    }
    
    // Save quote directly without candidate suggestions
    function saveQuoteDirectly(quoteData, isUpdate = false) {
      const actionText = isUpdate ? '×¢×•×“×›× ×”' : '× ×©××¨×”';
      const errorText = isUpdate ? '×¢×“×›×•×Ÿ' : '×©××™×¨×ª';
      
      ajaxCall('POST', `${API_BASE_URL}/Quote/CreateQuote`, JSON.stringify(quoteData),
        function(result) {
          if (result && result.success) {
            showToast(result.message || `×”×¦×¢×ª ××—×™×¨ ${actionText} ×‘×”×¦×œ×—×”!`);
            closeQuoteCalculator();
            loadExistingQuotes(); // Refresh quotes list and update buttons
          } else {
            showToast(result?.message || `×©×’×™××” ×‘${errorText} ×”×¦×¢×ª ×”××—×™×¨`, 'error');
            // Even if there's an error, close the calculator
            closeQuoteCalculator();
          }
        },
        function(error) {
          console.error('Error creating quote:', error);
          showToast(`×©×’×™××” ×‘${errorText} ×”×¦×¢×ª ×”××—×™×¨`, 'error');
          // Even if there's an error, close the calculator
          closeQuoteCalculator();
        }
      );
    }

    // View/Edit existing quote
    function viewEditQuote() {
      if (existingQuotes.length === 0) {
        showToast('×œ× × ××¦××• ×”×¦×¢×•×ª ××—×™×¨ ×§×™×™××•×ª', 'error');
        return;
      }

      // If there's only one quote, open it directly
      if (existingQuotes.length === 1) {
        editSpecificQuote(existingQuotes[0]);
        return;
      }

      // If there are multiple quotes, show selection modal
      showQuoteSelectionModal();
    }

    // Show quote selection modal for multiple quotes
    function showQuoteSelectionModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-96 overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold text-gray-900">×‘×—×¨ ×”×¦×¢×ª ××—×™×¨ ×œ×¢×¨×™×›×”</h2>
              <button onclick="this.closest('.fixed').remove()" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-3">
              ${existingQuotes.map(quote => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
                     onclick="editSpecificQuote(${JSON.stringify(quote).replace(/"/g, '&quot;')}); this.closest('.fixed').remove();">
                  <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-900">×”×¦×¢×” #${quote.quoteID}</span>
                    <span class="text-sm text-gray-500">${new Date(quote.createdAt).toLocaleDateString('he-IL')}</span>
                  </div>
                  <div class="text-lg font-semibold text-primary mb-2">â‚ª${quote.totalPrice.toLocaleString()}</div>
                  <div class="text-sm text-gray-600">${quote.items.length} ×¤×¨×™×˜×™×</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Edit specific quote
    function editSpecificQuote(quote) {
      // Open quote calculator modal
      const modal = document.getElementById('quoteCalculatorModal');
      if (modal) {
        modal.classList.remove('hidden');
        // Load the quote data into the calculator
        loadQuoteCalculatorForEdit(quote);
      } else {
        console.error('Quote calculator modal not found!');
        showToast('×©×’×™××” ×‘×¤×ª×™×—×ª ××—×©×‘×•×Ÿ ×”×¦×¢×ª ××—×™×¨ ×œ×¢×¨×™×›×”', 'error');
      }
    }

    // Load quote calculator with existing quote data for editing
    function loadQuoteCalculatorForEdit(quote) {
      const container = document.getElementById('quoteCalculatorContent');
      const totalArea = customerData.spaceDetails.reduce((sum, space) => sum + (space.size || 0), 0);
      
      container.innerHTML = `
        <div class="space-y-6">
          <!-- Edit Mode Header -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex items-center">
              <svg class="w-5 h-5 text-blue-600 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              <span class="text-blue-800 font-medium">×¢×¨×™×›×ª ×”×¦×¢×” #${quote.quoteID}</span>
            </div>
          </div>

          <!-- Floor Selection -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">×¤×¨×˜×™ ×¤×¨×§×˜ ×‘×¡×™×¡×™</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">×¡×•×’ ×¤×¨×§×˜</label>
                <select id="floorType" onchange="updateFloorPrice()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                  <option value="spc">SPC/×œ××™× ×¦×™×”</option>
                  <option value="wood">×¢×¥</option>
                  <option value="fishbone">×¤×™×©×‘×•×Ÿ</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">××—×™×¨ ×œ×"×¨</label>
                <input type="number" id="floorPricePerMeter" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">×¡×”"×› ×©×˜×—</label>
                <input type="number" id="totalArea" value="${totalArea}" readonly class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg">
              </div>
            </div>
            <div class="mt-4">
              <label class="flex items-center">
                <input type="checkbox" id="includeBaseFloor" checked class="mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2">
                <span class="text-sm font-medium text-gray-700">×›×œ×•×œ ×¤×¨×§×˜ ×‘×¡×™×¡×™ ×‘×”×¦×¢×”</span>
              </label>
            </div>
          </div>

          <!-- Calculator Items -->
          <div>
            <h3 class="text-lg font-semibold text-gray-900 mb-4">×¤×¨×™×˜×™× × ×•×¡×¤×™×</h3>
            <div id="calculatorItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <!-- Calculator items will be loaded here -->
            </div>
            
            <!-- Add Custom Item -->
            <div class="mt-6 border-2 border-dashed border-gray-300 rounded-lg p-6">
              <h4 class="text-md font-medium text-gray-900 mb-4">×”×•×¡×£ ×¤×¨×™×˜ ××•×ª×× ××™×©×™×ª</h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="relative">
                  <label class="block text-sm font-medium text-gray-700 mb-2">×©× ×”×¤×¨×™×˜</label>
                  <input type="text" id="customItemName" placeholder="×”×§×œ×“ ×©× ×¤×¨×™×˜..." 
                         oninput="showItemSuggestions(this.value)" onblur="setTimeout(hideSuggestions, 200)"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                  <div id="itemSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-40 overflow-y-auto">
                    <!-- Suggestions will appear here -->
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">××—×™×¨ ×œ×™×—×™×“×” (â‚ª)</label>
                  <input type="number" id="customItemPrice" placeholder="0" min="0" step="0.01"
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">×›××•×ª</label>
                  <div class="flex items-center space-x-2">
                    <button onclick="adjustCustomQuantity(-1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">-</button>
                    <span id="customItemQuantity" class="w-8 text-center font-medium">1</span>
                    <button onclick="adjustCustomQuantity(1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">+</button>
                  </div>
                </div>
              </div>
              <div class="mt-4 flex justify-center gap-3">
                <button onclick="addCustomItemToQuote()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                  ×”×•×¡×£ ×œ×—×™×©×•×‘
                </button>
                <button onclick="clearCustomItem()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                  × ×§×”
                </button>
              </div>
            </div>
          </div>

          <!-- Quote Preview -->
          <div class="bg-gray-50 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">×ª×¦×•×’×” ××§×“×™××”</h3>
            <div id="quotePreview" class="space-y-2">
              <!-- Quote preview will be updated here -->
            </div>
                          <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex items-center justify-between mb-4">
                  <label class="text-sm font-medium text-gray-700">×”× ×—×” (%)</label>
                  <input type="number" id="discountPercent" value="${quote.discountPercent || 0}" min="0" max="100" onchange="calculateQuote()" class="w-20 px-2 py-1 border border-gray-300 rounded">
                </div>
                <!-- Calculate button right under discount input -->
                <div class="mb-4 flex justify-end">
                  <button onclick="calculateQuote()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-sm">
                    ×—×©×‘ ××—×“×©
                  </button>
                </div>
                <!-- Edit mode buttons - centered -->
                <div class="flex justify-center gap-3">
                  <button onclick="updateQuote(${quote.quoteID})" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium shadow-md">
                    ×¢×“×›×Ÿ ×”×¦×¢×ª ××—×™×¨
                  </button>
                  <button onclick="deleteQuote(${quote.quoteID})" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium shadow-md">
                    ××—×§ ×”×¦×¢×”
                  </button>
                </div>
              </div>
          </div>
        </div>
      `;
      
      loadCalculatorItemsForEdit(quote);
      // Update parquet options after HTML is inserted for edit mode
      setTimeout(() => {
        const floorTypeSelect = document.getElementById('floorType');
        if (floorTypeSelect) {
          floorTypeSelect.innerHTML = generateParquetOptions();
        }
        
        // Load existing quote data into form fields
        if (quote.items && quote.items.length > 0) {
          // Try to find base floor item to extract floor details
          const baseFloorItem = quote.items.find(item => item.itemName && item.itemName.includes('×”×ª×§× ×ª ×¤×¨×§×˜'));
          if (baseFloorItem && baseFloorItem.notes) {
            // Extract area and price from notes (format: "XX ×"×¨ Ã— YY ×©"×—")
            const match = baseFloorItem.notes.match(/([0-9.]+)\s*×"×¨\s*Ã—\s*([0-9.]+)\s*×©"×—/);
            if (match) {
              const area = parseFloat(match[1]);
              const pricePerMeter = parseFloat(match[2]);
              
              document.getElementById('totalArea').value = area;
              document.getElementById('floorPricePerMeter').value = pricePerMeter;
            }
          }
        }
        
        updateFloorPrice();
      }, 100);
    }

    // Load calculator items with existing quote data
    function loadCalculatorItemsForEdit(quote) {
      console.log('ğŸ“‹ ×˜×•×¢×Ÿ × ×ª×•× ×™ ×”×¦×¢×ª ××—×™×¨ ×§×™×™××ª:', quote);
      ajaxCall('GET', `${API_BASE_URL}/Quote/GetCalculatorItems`, null,
        function(items) {
          calculatorItems = items;
          console.log('ğŸ”§ ×¤×¨×™×˜×™ ××—×©×‘×•×Ÿ:', items);
          console.log('ğŸ“¦ ×¤×¨×™×˜×™ ×”×”×¦×¢×”:', quote.items);
          renderCalculatorItemsForEdit(items, quote.items);
          calculateQuote();
        },
        function(error) {
          console.error('Error loading calculator items:', error);
          document.getElementById('calculatorItems').innerHTML = '<div class="text-gray-500 text-center py-4">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×™×˜×™ ××—×©×‘×•×Ÿ</div>';
        }
      );
    }

    // Render calculator items with existing quantities
    function renderCalculatorItemsForEdit(items, quoteItems) {
      const container = document.getElementById('calculatorItems');
      
      console.log('ğŸ¯ ××¢×‘×“ ×¤×¨×™×˜×™× ×œ×¢×¨×™×›×”:', { items, quoteItems });
      
      // Clear existing custom items array and DOM
      customItems = [];
      
      // Regular calculator items HTML
      const calculatorItemsHTML = items.map(item => {
        const existingItem = quoteItems.find(qi => qi.calculatorItemID === item.calculatorItemID);
        const quantity = existingItem ? existingItem.quantity : 0;
        
        return `
          <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow" data-item-id="${item.calculatorItemID}">
            <h4 class="font-medium text-gray-900 mb-2">${item.itemName}</h4>
            <p class="text-sm text-gray-600 mb-3">${item.description || ''}</p>
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm font-medium text-primary">â‚ª${item.price}</span>
              <div class="flex items-center space-x-2">
                <button onclick="adjustQuantity(${item.calculatorItemID}, -1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">-</button>
                <span id="qty_${item.calculatorItemID}" class="w-8 text-center font-medium">${quantity}</span>
                <button onclick="adjustQuantity(${item.calculatorItemID}, 1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">+</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Custom items (items without calculatorItemID) - excluding base floor
      const customQuoteItems = quoteItems.filter(qi => 
        (!qi.calculatorItemID || qi.calculatorItemID === null || qi.calculatorItemID === undefined) &&
        (!qi.itemName || !qi.itemName.includes('×”×ª×§× ×ª ×¤×¨×§×˜'))
      );
      console.log('ğŸ”µ ×¤×¨×™×˜×™× ××•×ª×××™× ××™×©×™×ª:', customQuoteItems);
      const customItemsHTML = customQuoteItems.map((customQuoteItem, index) => {
        // Add to custom items array for tracking
        const customItem = {
          id: Date.now() + index, // Unique ID
          itemName: customQuoteItem.itemName,
          price: customQuoteItem.unitPrice,
          quantity: customQuoteItem.quantity,
          isCustom: true,
          notes: customQuoteItem.notes || ""
        };
        customItems.push(customItem);
        
        return `
          <div class="border border-blue-200 bg-blue-50 rounded-lg p-4 hover:shadow-md transition-shadow" data-custom-item-id="${customItem.id}">
            <div class="flex items-center justify-between mb-2">
              <h4 class="font-medium text-gray-900">${customItem.itemName}</h4>
              <button onclick="removeCustomItem(${customItem.id})" class="text-red-500 hover:text-red-700 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <p class="text-sm text-blue-600 mb-3">×¤×¨×™×˜ ××•×ª×× ××™×©×™×ª</p>
            <div class="flex items-center justify-between mb-3">
              <span class="text-sm font-medium text-primary">â‚ª${customItem.price}</span>
              <div class="flex items-center space-x-2">
                <button onclick="adjustCustomItemQuantity(${customItem.id}, -1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">-</button>
                <span id="custom_qty_${customItem.id}" class="w-8 text-center font-medium">${customItem.quantity}</span>
                <button onclick="adjustCustomItemQuantity(${customItem.id}, 1)" class="w-8 h-8 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition-colors">+</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Combine both calculator items and custom items
      container.innerHTML = calculatorItemsHTML + customItemsHTML;
    }

    // Update existing quote (delete old and create new)
    function updateQuote(quoteId) {
      console.log(`ğŸ”„ ××¢×“×›×Ÿ ×”×¦×¢×ª ××—×™×¨ ${quoteId} - ××•×—×§ ×•×™×•×¦×¨ ××—×“×©`);
      
      // First delete the existing quote
      ajaxCall('DELETE', `${API_BASE_URL}/Quote/DeleteQuote/${quoteId}`, null,
        function(deleteResult) {
          if (deleteResult && deleteResult.success) {
            console.log('âœ… ×”×¦×¢×ª ××—×™×¨ ×™×©× ×” × ××—×§×”, ×™×•×¦×¨ ×”×¦×¢×” ×—×“×©×”');
            
            // Now create a new quote with the current data
            const data = gatherQuoteData();
            
            // Check for popular candidates before saving the new quote (as update)
            checkForPopularCandidatesBeforeSave(data, true);
          } else {
            console.error('âŒ ×©×’×™××” ×‘××—×™×§×ª ×”×¦×¢×ª ×”××—×™×¨ ×”×™×©× ×”');
            showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¦×¢×ª ×”××—×™×¨', 'error');
            closeQuoteCalculator();
          }
        },
        function(error) {
          console.error('Error deleting quote for update:', error);
          showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×¦×¢×ª ×”××—×™×¨', 'error');
          closeQuoteCalculator();
        }
      );
    }

    // Delete quote
    function deleteQuote(quoteId) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¦×¢×ª ×”××—×™×¨?')) {
        return;
      }
      
      ajaxCall('DELETE', `${API_BASE_URL}/Quote/DeleteQuote/${quoteId}`, null,
        function(result) {
          if (result && result.success) {
            showToast(result.message || '×”×¦×¢×ª ××—×™×¨ × ××—×§×” ×‘×”×¦×œ×—×”!');
            closeQuoteCalculator();
            loadExistingQuotes(); // Refresh quotes list and update buttons
          } else {
            showToast(result?.message || '×©×’×™××” ×‘××—×™×§×ª ×”×¦×¢×ª ×”××—×™×¨', 'error');
          }
        },
        function(error) {
          console.error('Error deleting quote:', error);
          showToast('×©×’×™××” ×‘××—×™×§×ª ×”×¦×¢×ª ×”××—×™×¨', 'error');
        }
      );
    }



    // === CUSTOMER VIDEOS FUNCTIONS === //
    
    // Load customer videos
    function loadCustomerVideos() {
      console.log('ğŸ¥ ×˜×•×¢×Ÿ ×¡×¨×˜×•× ×™× ×¢×‘×•×¨ ×œ×§×•×—:', currentCustomerID);
      
      ajaxCall('GET', `${API_BASE_URL}/CustomerDetails/GetCustomerVideos/${currentCustomerID}`, null,
        function(response) {
          console.log('ğŸ“¨ ×ª×’×•×‘×” ××”×©×¨×ª:', response);
          
          if (response && response.success && response.videos && response.videos.length > 0) {
            console.log('âœ… × ××¦××• ×¡×¨×˜×•× ×™×:', response.videos);
            // Convert MediaURL strings to video objects
            customerVideos = response.videos.map((url, index) => ({
              videoPath: url,
              url: url,
              index: index + 1
            }));
            console.log('ğŸ”„ ××¢×¨×š ×¡×¨×˜×•× ×™× ××¢×•×‘×“:', customerVideos);
            currentVideoIndex = 0;
            renderCustomerVideos();
          } else {
            console.log('âš ï¸ ×œ× × ××¦××• ×¡×¨×˜×•× ×™× ××• ×ª×’×•×‘×” ×¨×™×§×”');
            customerVideos = [];
            renderCustomerVideos();
          }
        },
        function(error) {
          console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×¨×˜×•× ×™×:', error);
          customerVideos = [];
          renderCustomerVideos();
        }
      );
    }

    
    // Render customer videos
    function renderCustomerVideos() {
      console.log('ğŸ–¼ï¸ ××¨× ×“×¨ ×¡×¨×˜×•× ×™×:', { customerVideos, length: customerVideos.length });
      
      const videoCountElement = document.getElementById('videoCount');
      const noVideosMessage = document.getElementById('noVideosMessage');
      const videoPlayer = document.getElementById('videoPlayer');
      
      videoCountElement.innerHTML = `ğŸ¥ ${customerVideos.length} ×¡×¨×˜×•× ×™×`;
      
      if (customerVideos.length === 0) {
        console.log('ğŸ“‹ ××¦×™×’ ×”×•×“×¢×ª "××™×Ÿ ×¡×¨×˜×•× ×™×"');
        noVideosMessage.classList.remove('hidden');
        videoPlayer.classList.add('hidden');
        return;
      }
      
      console.log('ğŸ¬ ××¦×™×’ × ×’×Ÿ ×¡×¨×˜×•× ×™×');
      noVideosMessage.classList.add('hidden');
      videoPlayer.classList.remove('hidden');
      
      // Show first video
      currentVideoIndex = 0;
      displayVideo(currentVideoIndex);
      
      // Setup navigation
      setupVideoNavigation();
      
      // Render thumbnails
      renderVideoThumbnails();
      
      console.log('âœ… ×¨×™× ×“×•×¨ ×¡×¨×˜×•× ×™× ×”×•×©×œ×');
    }
    
    // Convert Google Drive URL to embeddable format
    function getEmbeddableUrl(url) {
      if (!url) return url;
      
      // Check if it's a Google Drive URL
      if (url.includes('drive.google.com')) {
        // Extract file ID from Google Drive URL
        const fileIdMatch = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        if (fileIdMatch) {
          const fileId = fileIdMatch[1];
          // Return embed URL
          return `https://drive.google.com/file/d/${fileId}/preview`;
        }
      }
      
      return url;
    }
    
    // Display specific video
    function displayVideo(index) {
      if (!customerVideos || customerVideos.length === 0 || index < 0 || index >= customerVideos.length) {
        console.log('âŒ ×œ× × ×™×ª×Ÿ ×œ×”×¦×™×’ ×¡×¨×˜×•×Ÿ - ××™× ×“×§×¡ ×œ× ×ª×§×™×Ÿ ××• ××™×Ÿ ×¡×¨×˜×•× ×™×');
        return;
      }
      
      const video = customerVideos[index];
      const videoElement = document.getElementById('currentVideo');
      const videoInfo = document.getElementById('videoInfo');
      const videoContainer = videoElement.parentElement;
      const originalUrl = video.videoPath || video.url;
      
      console.log('ğŸ¥ ××¦×™×’ ×¡×¨×˜×•×Ÿ:', { index, originalUrl, video });
      
      // Remove any existing iframe
      const existingIframe = videoContainer.querySelector('iframe');
      if (existingIframe) {
        existingIframe.remove();
      }
      
      // Check if it's a Google Drive URL
      if (originalUrl && originalUrl.includes('drive.google.com')) {
        console.log('ğŸ“± ××¦×™×’ ×¡×¨×˜×•×Ÿ Google Drive');
        // Hide video element and create iframe
        videoElement.style.display = 'none';
        
        const iframe = document.createElement('iframe');
        iframe.src = getEmbeddableUrl(originalUrl);
        iframe.width = '100%';
        iframe.height = '400';
        iframe.frameBorder = '0';
        iframe.allowFullscreen = true;
        iframe.className = 'w-full max-w-4xl mx-auto rounded-lg shadow-lg';
        iframe.style.maxWidth = '100%';
        
        // Insert iframe after video element
        videoElement.parentNode.insertBefore(iframe, videoElement.nextSibling);
      } else {
        console.log('ğŸ¬ ××¦×™×’ ×¡×¨×˜×•×Ÿ ××§×•××™');
        // Show video element for regular/local videos
        videoElement.style.display = 'block';
        
        // Handle local URLs - use the API endpoint
        let videoSrc = originalUrl;
        if (videoSrc && videoSrc.startsWith('/uploads/videos/')) {
          // Extract filename and use API endpoint
          const fileName = videoSrc.substring('/uploads/videos/'.length);
          videoSrc = `${API_BASE_URL}/CustomerDetails/GetVideo/${fileName}`;
          console.log('ğŸ”— ××©×ª××© ×‘-API endpoint:', videoSrc);
        } else if (videoSrc && !videoSrc.startsWith('http')) {
          // Convert relative URL to absolute URL as fallback
          videoSrc = window.location.origin + videoSrc;
          console.log('ğŸ”— ×”××¨ URL ×™×—×¡×™ ×œ×’×œ×•×‘×œ×™:', videoSrc);
        }
        
        videoElement.src = videoSrc;
        videoElement.load();
        
        // Add error handling for video element
        videoElement.onerror = function() {
          console.error('âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×¨×˜×•×Ÿ:', videoSrc);
          showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¡×¨×˜×•×Ÿ', 'error');
        };
        
        videoElement.onloadeddata = function() {
          console.log('âœ… ×¡×¨×˜×•×Ÿ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”:', videoSrc);
        };
      }
      
      // Update video info
      videoInfo.textContent = `×¡×¨×˜×•×Ÿ ${index + 1} ××ª×•×š ${customerVideos.length}`;
      
      // Update navigation buttons
      const prevBtn = document.getElementById('prevVideoBtn');
      const nextBtn = document.getElementById('nextVideoBtn');
      
      if (customerVideos.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
      } else {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
        prevBtn.disabled = index === 0;
        nextBtn.disabled = index === customerVideos.length - 1;
        
        // Update button opacity based on state
        prevBtn.style.opacity = index === 0 ? '0.3' : '1';
        nextBtn.style.opacity = index === customerVideos.length - 1 ? '0.3' : '1';
      }
      
      // Update thumbnail selection
      updateThumbnailSelection(index);
    }
    
    // Setup video navigation
    function setupVideoNavigation() {
      const prevBtn = document.getElementById('prevVideoBtn');
      const nextBtn = document.getElementById('nextVideoBtn');
      
      prevBtn.onclick = () => navigateVideo(-1);
      nextBtn.onclick = () => navigateVideo(1);
      
      // Add keyboard navigation
      document.addEventListener('keydown', function(e) {
        if (customerVideos.length > 0 && !document.querySelector('.modal:not(.hidden)')) {
          if (e.key === 'ArrowLeft') {
            navigateVideo(-1);
          } else if (e.key === 'ArrowRight') {
            navigateVideo(1);
          }
        }
      });
    }
    
    // Navigate between videos
    function navigateVideo(direction) {
      const newIndex = currentVideoIndex + direction;
      
      if (newIndex >= 0 && newIndex < customerVideos.length) {
        currentVideoIndex = newIndex;
        displayVideo(currentVideoIndex);
      }
    }
    
    // Render video thumbnails
    function renderVideoThumbnails() {
      const thumbnailsContainer = document.getElementById('videoThumbnails');
      
      if (customerVideos.length <= 1) {
        thumbnailsContainer.style.display = 'none';
        return;
      }
      
      thumbnailsContainer.style.display = 'flex';
      thumbnailsContainer.innerHTML = customerVideos.map((video, index) => `
        <button onclick="showVideoByIndex(${index})" 
                class="video-thumbnail w-16 h-12 bg-gray-200 rounded border-2 hover:border-blue-500 transition-all duration-200 flex items-center justify-center text-xs font-medium ${
                  index === currentVideoIndex ? 'border-blue-500 bg-blue-100' : 'border-gray-300'
                }" 
                data-index="${index}">
          <div class="text-center">
            <div class="text-lg">ğŸ¥</div>
            <div>${index + 1}</div>
          </div>
        </button>
      `).join('');
    }
    
    // Update thumbnail selection
    function updateThumbnailSelection(activeIndex) {
      const thumbnails = document.querySelectorAll('.video-thumbnail');
      thumbnails.forEach((thumbnail, index) => {
        if (index === activeIndex) {
          thumbnail.classList.add('border-blue-500', 'bg-blue-100');
          thumbnail.classList.remove('border-gray-300');
        } else {
          thumbnail.classList.remove('border-blue-500', 'bg-blue-100');
          thumbnail.classList.add('border-gray-300');
        }
      });
    }
    
    // Show video by index (called from thumbnail click)
    function showVideoByIndex(index) {
      currentVideoIndex = index;
      displayVideo(currentVideoIndex);
    }
    
    // Play all videos in sequence
    function playAllVideos() {
      if (customerVideos.length === 0) {
        showToast('××™×Ÿ ×¡×¨×˜×•× ×™× ×œ× ×’×Ÿ', 'info');
        return;
      }
      
      currentVideoIndex = 0;
      displayVideo(currentVideoIndex);
      
      const videoElement = document.getElementById('currentVideo');
      videoElement.play();
      
      // Setup auto-play for next video when current ends
      videoElement.onended = function() {
        if (currentVideoIndex < customerVideos.length - 1) {
          setTimeout(() => {
            navigateVideo(1);
            document.getElementById('currentVideo').play();
          }, 1000); // 1 second delay between videos
        } else {
          showToast('× ×’×™× ×ª ×›×œ ×”×¡×¨×˜×•× ×™× ×”×•×©×œ××”', 'success');
        }
      };
      
      showToast(`××ª×—×™×œ × ×’×™× ×ª ${customerVideos.length} ×¡×¨×˜×•× ×™×`, 'info');
    }
    

    
    // === END CUSTOMER VIDEOS FUNCTIONS === //

    // === PRICE ESTIMATE FUNCTIONS === //
    
    // Load price estimate for current request
    function loadPriceEstimate() {
      if (!currentRequestID) {
        console.warn('ğŸ” ×œ× × ××¦× RequestID ×œ×”×¢×¨×›×ª ××—×™×¨');
        renderNoEstimate();
        return;
      }
      
      console.log('ğŸ’° ×˜×•×¢×Ÿ ×”×¢×¨×›×ª ××—×™×¨ ×¢×‘×•×¨ RequestID:', currentRequestID);
      
      ajaxCall('GET', `${API_BASE_URL}/PriceEstimator/GetEstimateByRequestID/${currentRequestID}`, null,
        function(estimate) {
          console.log('ğŸ“Š × ×˜×¢× ×” ×”×¢×¨×›×ª ××—×™×¨:', estimate);
          priceEstimate = estimate;
          renderPriceEstimate(estimate);
        },
        function(error) {
          console.error('Error loading price estimate:', error);
          renderNoEstimate();
        }
      );
    }
    
    // Render price estimate data
    function renderPriceEstimate(estimate) {
      const container = document.getElementById('estimatesContainer');
      const statusElement = document.getElementById('estimateStatus');
      const detailsSection = document.getElementById('estimateDetails');
      
      statusElement.innerHTML = '×–××™×Ÿ';
      statusElement.className = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
      
      // Format price range
      const priceRange = estimate.estimatedMinPrice === estimate.estimatedMaxPrice 
        ? `â‚ª${estimate.estimatedMinPrice.toLocaleString()}`
        : `â‚ª${estimate.estimatedMinPrice.toLocaleString()} - â‚ª${estimate.estimatedMaxPrice.toLocaleString()}`;
      
      // Format duration range
      const durationRange = estimate.estimatedMinDays === estimate.estimatedMaxDays
        ? `${estimate.estimatedMinDays} ×™××™×`
        : `${estimate.estimatedMinDays} - ${estimate.estimatedMaxDays} ×™××™×`;
      
      container.innerHTML = `
        <!-- Price Card -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                </svg>
              </div>
              <div class="mr-4">
                <h4 class="text-lg font-semibold text-gray-900">×”×¢×¨×›×ª ××—×™×¨</h4>
                <p class="text-sm text-gray-600">×œ×¤×™ × ×ª×•× ×™ ×”×¨×™×©×•×</p>
              </div>
            </div>
          </div>
          <div class="text-2xl font-bold text-green-700 mb-2">${priceRange}</div>
          <div class="text-sm text-gray-600">
            <div class="flex items-center">
              <span class="inline-block w-2 h-2 bg-green-400 rounded-full ml-2"></span>
              ×œ× ×›×•×œ×œ ××¢"×
            </div>
          </div>
        </div>
        
        <!-- Duration Card -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
              <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <div class="mr-4">
                <h4 class="text-lg font-semibold text-gray-900">×–××Ÿ ×”×ª×§× ×”</h4>
                <p class="text-sm text-gray-600">×××“×Ÿ ×™××™ ×¢×‘×•×“×”</p>
              </div>
            </div>
          </div>
                     <div class="text-2xl font-bold text-blue-700 mb-2">${durationRange}</div>
        </div>
      `;
      
      // Show estimate details
      detailsSection.classList.remove('hidden');
      updateEstimateDetails(estimate);
    }
    
    // Update estimate details section
    function updateEstimateDetails(estimate) {
      document.getElementById('estimateTotalArea').textContent = `${estimate.totalArea.toFixed(1)} ×"×¨`;
      document.getElementById('estimateParquetType').textContent = estimate.parquetType || '×œ× ×¦×•×™×Ÿ';
      document.getElementById('estimateRoomCount').textContent = estimate.roomCount || 1;
      document.getElementById('estimateNotes').textContent = estimate.notes || '××™×Ÿ ×”×¢×¨×•×ª × ×•×¡×¤×•×ª';
    }
    
    // Render when no estimate is available
    function renderNoEstimate() {
      const container = document.getElementById('estimatesContainer');
      const statusElement = document.getElementById('estimateStatus');
      const detailsSection = document.getElementById('estimateDetails');
      
      statusElement.innerHTML = 'âš ï¸ ×œ× ×–××™×Ÿ';
      statusElement.className = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
      
      container.innerHTML = `
        <div class="col-span-full">
          <div class="bg-gray-50 rounded-xl p-8 text-center border-2 border-dashed border-gray-300">
            <div class="text-4xl mb-4">ğŸ’­</div>
            <h4 class="text-lg font-medium text-gray-900 mb-2">××™×Ÿ ×”×¢×¨×›×ª ××—×™×¨ ×–××™× ×”</h4>
            <p class="text-gray-600 mb-4">×œ× × ××¦××” ×”×¢×¨×›×ª ××—×™×¨ ×¢×‘×•×¨ ×‘×§×©×” ×–×•</p>
            <div class="text-sm text-gray-500">
              <div class="flex items-center justify-center">
                <span class="inline-block w-2 h-2 bg-gray-400 rounded-full ml-2"></span>
                ×”×”×¢×¨×›×” ×ª×ª×•×•×¡×£ ××•×˜×•××˜×™×ª ×‘×¡×™×•× ×”×¨×™×©×•×
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Hide estimate details
      detailsSection.classList.add('hidden');
    }
    
    // === END PRICE ESTIMATE FUNCTIONS === //

    // === PERMANENT ITEM MODAL FUNCTIONS === //
    
    let currentModalItemName = null; // Track current item for rejection handling
    let modalClosedByCreation = false; // Track if modal was closed by successful creation
    
    // Show dialog for popular candidates before saving quote
    function showPopularCandidatesDialog(popularCustomItems, allCandidates, quoteData, isUpdate = false) {
      console.log('ğŸ¯ × ××¦××• ××•×¢××“×™× ×¤×•×¤×•×œ×¨×™×™×:', popularCustomItems);
      
      const modal = document.createElement('div');
      modal.id = 'candidatesModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
          <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h2 class="text-xl font-semibold text-gray-900">××•×¢××“×™× ×¤×•×¤×•×œ×¨×™×™× ×œ×”××¨×” ×œ×¤×¨×™×˜×™× ×§×‘×•×¢×™×</h2>
                             <button id="closeBtn" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">×–×•×”×• ×¤×¨×™×˜×™× ××•×ª×××™× ××™×©×™×ª ×©×›×‘×¨ ×©×™××©×• ××¡×¤×¨ ×¤×¢××™×. ×”×× ×ª×¨×¦×” ×œ×™×¦×•×¨ ××”× ×¤×¨×™×˜×™× ×§×‘×•×¢×™× ×‘××—×©×‘×•×Ÿ?</p>
          </div>
          <div class="p-6">
            <div class="space-y-4" id="candidatesDialogList">
              ${popularCustomItems.map((customItem, index) => {
                const candidate = allCandidates.find(c => c.customItemName === customItem.ItemName);
                return `
                  <div class="border border-yellow-200 bg-yellow-50 rounded-lg p-4" data-item-name="${customItem.ItemName}">
                    <div class="flex items-start justify-between mb-3">
                      <div class="flex-1">
                        <h4 class="font-medium text-gray-900">${customItem.ItemName}</h4>
                        <p class="text-sm text-gray-600 mt-1">××—×™×¨ ×‘×”×¦×¢×”: â‚ª${customItem.UnitPrice} â€¢ ×›××•×ª: ${customItem.Quantity}</p>
                        <div class="flex items-center mt-2">
                          <svg class="w-4 h-4 text-blue-600 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                          </svg>
                          <span class="text-sm text-blue-800 font-medium">×©×™××© ${candidate.occurrences} ×¤×¢××™× â€¢ ××—×™×¨ ××•×¦×¢: â‚ª${candidate.suggestedPrice.toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 space-x-reverse">
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" class="candidate-action" data-action="create" data-item="${customItem.ItemName}" checked
                               class="mr-2 w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
                        <span class="text-sm font-medium text-green-700 mr-2">×¦×•×¨ ×¤×¨×™×˜ ×§×‘×•×¢</span>
                      </label>
                      
                      <label class="flex items-center cursor-pointer">
                        <input type="checkbox" class="candidate-action" data-action="reject" data-item="${customItem.ItemName}"
                               class="mr-2 w-4 h-4 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                        <span class="text-sm font-medium text-red-700 mr-2">×“×—×” ×”××œ×¦×”</span>
                      </label>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            
                         <div class="flex justify-center gap-3 mt-6">
               <button id="processBtn" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium shadow-md">
                 âœ“ ×‘×¦×¢ ×¤×¢×•×œ×•×ª ×•×©××•×¨ ×”×¦×¢×”
               </button>
               <button id="ignoreBtn" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium">
                 ×‘×™×˜×•×œ
               </button>
             </div>
          </div>
        </div>
      `;
             
       document.body.appendChild(modal);
       
       // Add event listeners for radio-like behavior
       modal.addEventListener('change', function(e) {
         if (e.target.type === 'checkbox' && e.target.classList.contains('candidate-action')) {
           const itemName = e.target.dataset.item;
           const allCheckboxes = modal.querySelectorAll(`input[data-item="${itemName}"]`);
           
           // Uncheck all other checkboxes for this item
           allCheckboxes.forEach(checkbox => {
             if (checkbox !== e.target) {
               checkbox.checked = false;
             }
           });
         }
       });
       
       // Add button event listeners
       modal.querySelector('#processBtn').addEventListener('click', function() {
         console.log('ğŸ”˜ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "×‘×¦×¢ ×¤×¢×•×œ×•×ª"');
         processSelectedCandidates(quoteData, isUpdate);
       });
       
       modal.querySelector('#ignoreBtn').addEventListener('click', function() {
         console.log('ğŸ”˜ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ "×‘×™×˜×•×œ"');
         modal.remove();
         saveQuoteDirectly(quoteData, isUpdate);
       });
       
       modal.querySelector('#closeBtn').addEventListener('click', function() {
         console.log('ğŸ”˜ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×¡×’×™×¨×” (X)');
         modal.remove();
         saveQuoteDirectly(quoteData, isUpdate);
       });
       
       // Close modal when clicking outside
       modal.addEventListener('click', function(e) {
         if (e.target === modal) {
           modal.remove();
           saveQuoteDirectly(quoteData, isUpdate);
         }
       });
     }
     
           // Process selected candidate actions and save quote
      function processSelectedCandidates(quoteData, isUpdate = false) {
        console.log('ğŸ”„ ××ª×—×™×œ ×œ×¢×‘×“ ×¤×¢×•×œ×•×ª × ×‘×—×¨×•×ª');
        const modal = document.getElementById('candidatesModal');
        
        if (!modal) {
          console.error('âŒ ×œ× × ××¦× ××•×“×œ ×”××•×¢××“×™×');
          saveQuoteDirectly(quoteData);
          return;
        }
        
        const selectedActions = [];
       
       // Collect all selected actions
       const checkboxes = modal.querySelectorAll('input.candidate-action:checked');
       console.log('ğŸ“ × ××¦××•', checkboxes.length, '×ª×™×‘×•×ª ×¡×™××•×Ÿ ××¡×•×× ×•×ª');
       
       checkboxes.forEach(checkbox => {
         selectedActions.push({
           itemName: checkbox.dataset.item,
           action: checkbox.dataset.action
         });
       });
       
       console.log('ğŸ¯ ×¤×¢×•×œ×•×ª × ×‘×—×¨×•×ª:', selectedActions);
       
       // Close modal first
       console.log('ğŸšª ×¡×•×’×¨ ××ª ×”××•×“×œ');
       modal.remove();
       
               // Process actions in sequence, then save quote
        processActionsSequentially(selectedActions, 0, quoteData, isUpdate);
      }
      
      // Process actions one by one
      function processActionsSequentially(actions, index, quoteData, isUpdate = false) {
        if (index >= actions.length) {
          // All actions processed, save quote
          console.log('âœ… ×›×œ ×”×¤×¢×•×œ×•×ª ×”×•×©×œ××•, ×©×•××¨ ×”×¦×¢×ª ××—×™×¨');
          
          saveQuoteDirectly(quoteData, isUpdate);
          return;
        }
       
       const action = actions[index];
       console.log(`ğŸ”„ ××¢×‘×“ ×¤×¢×•×œ×” ${index + 1}/${actions.length}: ${action.action} ×¢×‘×•×¨ "${action.itemName}"`);
       
       switch (action.action) {
         case 'create':
           // Create permanent item from candidate
           ajaxCall('POST', `${API_BASE_URL}/PriceCalculatorItem/CreateFromCandidate`, JSON.stringify(action.itemName),
             function(result) {
               if (result && result > 0) {
                 console.log(`âœ… ×¤×¨×™×˜ "${action.itemName}" × ×•×¦×¨ ×›×¤×¨×™×˜ ×§×‘×•×¢`);
                 showToast(`×¤×¨×™×˜ "${action.itemName}" × ×•×¦×¨ ×‘×”×¦×œ×—×” ×‘××—×©×‘×•×Ÿ!`, 'success');
               } else {
                 console.log(`âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¨×™×˜ "${action.itemName}"`);
               }
               // Continue to next action
               processActionsSequentially(actions, index + 1, quoteData, isUpdate);
             },
             function(error) {
               console.error(`Error creating item "${action.itemName}":`, error);
               // Continue even on error
               processActionsSequentially(actions, index + 1, quoteData, isUpdate);
             }
           );
           break;
           
         case 'reject':
           // Reject candidate
           ajaxCall('POST', `${API_BASE_URL}/PriceCalculatorItem/RejectCandidate`, JSON.stringify(action.itemName),
             function(result) {
               if (result && result > 0) {
                 console.log(`âœ… ×”××œ×¦×” ×¢×‘×•×¨ "${action.itemName}" × ×“×—×ª×”`);
                 showToast(`×”×”××œ×¦×” ×¢×‘×•×¨ "${action.itemName}" × ×“×—×ª×”`, 'info');
               } else {
                 console.log(`âŒ ×©×’×™××” ×‘×“×—×™×™×ª ×”××œ×¦×” ×¢×‘×•×¨ "${action.itemName}"`);
               }
               // Continue to next action
               processActionsSequentially(actions, index + 1, quoteData, isUpdate);
             },
             function(error) {
               console.error(`Error rejecting candidate "${action.itemName}":`, error);
               // Continue even on error
               processActionsSequentially(actions, index + 1, quoteData, isUpdate);
             }
           );
           break;
           
         default:
           // Unknown action, just continue
           console.log(`âš ï¸ ×¤×¢×•×œ×” ×œ× ××•×›×¨×ª: ${action.action} ×¢×‘×•×¨ "${action.itemName}"`);
           processActionsSequentially(actions, index + 1, quoteData, isUpdate);
           break;
       }
     }
     
     // Open permanent item creation modal
    function openPermanentItemModal(itemName, itemPrice) {
      currentModalItemName = itemName;
      modalClosedByCreation = false;
      
      document.getElementById('permanentItemName').value = itemName;
      document.getElementById('permanentItemPrice').value = itemPrice;
      document.getElementById('permanentItemDescription').value = '';
      
      // Check if item exists in candidates to get smart data
      ajaxCall('GET', `${API_BASE_URL}/PriceCalculatorItem/GetPopularCandidates`, null,
        function(candidates) {
          const existingCandidate = candidates.find(c => c.customItemName === itemName);
          
          if (existingCandidate) {
            // Use suggested price from candidates table
            document.getElementById('permanentItemPrice').value = existingCandidate.suggestedPrice;
            
            // Show usage statistics
            const statsSection = document.getElementById('usageStatsSection');
            const statsText = document.getElementById('usageStatsText');
            statsText.textContent = `×”×¤×¨×™×˜ ×©×™××© ${existingCandidate.occurrences} ×¤×¢××™× â€¢ ××—×™×¨ ×××•×¦×¢: â‚ª${existingCandidate.suggestedPrice.toFixed(2)}`;
            statsSection.classList.remove('hidden');
            
            // Suggest description based on existing data
            if (existingCandidate.suggestedDescription) {
              document.getElementById('permanentItemDescription').value = existingCandidate.suggestedDescription;
            }
          } else {
            // Hide stats section if no candidate data
            document.getElementById('usageStatsSection').classList.add('hidden');
          }
          
          // Show the modal
          document.getElementById('createPermanentItemModal').classList.remove('hidden');
        },
        function(error) {
          console.error('Error loading candidates:', error);
          // Show modal anyway with default values
          document.getElementById('usageStatsSection').classList.add('hidden');
          document.getElementById('createPermanentItemModal').classList.remove('hidden');
        }
      );
    }
    
    // Close permanent item modal
    function closePermanentItemModal() {
      document.getElementById('createPermanentItemModal').classList.add('hidden');
      
      // If modal was closed without creation, mark item as rejected
      if (currentModalItemName && !modalClosedByCreation) {
        rejectCurrentCandidate();
      }
      
      // Reset tracking variables
      currentModalItemName = null;
      modalClosedByCreation = false;
    }
    
    // Reject current candidate
    function rejectCurrentCandidate() {
      if (!currentModalItemName) return;
      
      ajaxCall('POST', `${API_BASE_URL}/PriceCalculatorItem/RejectCandidate`, JSON.stringify(currentModalItemName),
        function(result) {
          if (result && result > 0) {
            console.log(`×¤×¨×™×˜ "${currentModalItemName}" ×¡×•××Ÿ ×›× ×“×—×”`);
          }
        },
        function(error) {
          console.error('Error rejecting candidate:', error);
        }
      );
    }
    
    // Confirm creation of permanent item
    function confirmCreatePermanentItem() {
      const itemName = document.getElementById('permanentItemName').value.trim();
      const itemPrice = parseFloat(document.getElementById('permanentItemPrice').value) || 0;
      const itemDescription = document.getElementById('permanentItemDescription').value.trim();
      
      if (!itemName) {
        showToast('×©× ×”×¤×¨×™×˜ ×—×•×‘×”', 'error');
        return;
      }
      
      if (itemPrice <= 0) {
        showToast('××—×™×¨ ×”×¤×¨×™×˜ ×—×™×™×‘ ×œ×”×™×•×ª ×’×“×•×œ ×-0', 'error');
        return;
      }
      
      createPermanentCalculatorItem(itemName, itemPrice, itemDescription);
      modalClosedByCreation = true; // Mark that modal is closing due to successful creation
      closePermanentItemModal();
    }

    // Create permanent calculator item from custom item
    function createPermanentCalculatorItem(itemName, itemPrice, itemDescription = '') {
      // Always create with the custom description and price
      const itemData = {
        ItemName: itemName,
        Price: itemPrice,
        Description: itemDescription || `×¤×¨×™×˜ ${itemName}`,
        IsActive: true
      };
      
      ajaxCall('POST', `${API_BASE_URL}/PriceCalculatorItem/AddNewCalculatorItem`, JSON.stringify(itemData),
        function(result) {
          if (result && result > 0) {
            showToast(`×¤×¨×™×˜ "${itemName}" × ×•×¦×¨ ×‘×”×¦×œ×—×” ×‘××—×©×‘×•×Ÿ ×”×§×‘×•×¢! ğŸ‰`, 'success');
            
            // If this item was a candidate, mark it as created
            markCandidateAsCreated(itemName);
            
            // Refresh calculator items if in creation mode
            if (document.getElementById('calculatorItems')) {
              loadCalculatorItems();
            }
          } else {
            showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×¤×¨×™×˜ ×‘××—×©×‘×•×Ÿ - ×™×™×ª×›×Ÿ ×©×”×•× ×›×‘×¨ ×§×™×™×', 'error');
          }
        },
        function(error) {
          console.error('Error creating permanent calculator item:', error);
          showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×¤×¨×™×˜ ×§×‘×•×¢ ×‘××—×©×‘×•×Ÿ', 'error');
        }
      );
    }
    
    // Mark candidate as created (updates IsCreated field)
    function markCandidateAsCreated(itemName) {
      ajaxCall('POST', `${API_BASE_URL}/PriceCalculatorItem/CreateFromCandidate`, JSON.stringify(itemName),
        function(result) {
          console.log(`××•×¢××“ "${itemName}" ×¡×•××Ÿ ×›× ×•×¦×¨ ×‘×”×¦×œ×—×”`);
        },
        function(error) {
          console.log(`××•×¢××“ "${itemName}" ×œ× × ××¦× ×‘×˜×‘×œ×ª ×”××•×¢××“×™×`);
        }
      );
    }

    // Show toast notification
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      
      let bgColor, icon, duration;
      
      switch(type) {
        case 'success':
          bgColor = 'bg-green-500';
          icon = 'âœ“';
          duration = 3000;
          break;
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'âœ—';
          duration = 4000;
          break;
        case 'info':
          bgColor = 'bg-blue-500';
          icon = 'ğŸ’¡';
          duration = 4000;
          break;
        default:
          bgColor = 'bg-gray-500';
          icon = 'â€¢';
          duration = 3000;
      }
      
      toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full max-w-md`;
      toast.innerHTML = `
        <div class="flex items-center space-x-3 space-x-reverse">
          <span class="text-lg flex-shrink-0">${icon}</span>
          <span class="font-medium text-sm leading-tight">${message}</span>
        </div>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.remove('translate-x-full'), 100);
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          if (container.contains(toast)) {
            container.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // Handle escape key to close modals
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeQuoteCalculator();
        closePermanentItemModal();
      }
    });
  </script>
</body>
</html>
